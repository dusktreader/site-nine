# Handoff: Multi-Tool Architecture Implementation

**From:** Architect (Ptah)  
**To:** Builder (Any)  
**Date:** 2026-02-03 13:41:40  
**Status:** pending  
**Priority:** HIGH

## Summary

Architecture design for site-nine multi-tool support is **COMPLETE**. All design documents, ADRs, PoC specifications, and implementation roadmap are ready. The Builder should now implement **Phase 1: Adapter Foundation**.

**Task:** None created yet - Builder should create Phase 1 implementation tasks  
**Size:** XL (Extra Large - 7 tasks ranging from Medium to Extra Large)  
**Branch:** main (create feature branch for implementation)

## Context

### What Was Done (Architecture Phase)

**Task ARC-H-0030 - COMPLETE ✅**

Created comprehensive architecture for making site-nine compatible with multiple AI coding tools (OpenCode, Cursor, Aider, etc.):

1. **5 Architecture Decision Records (ADRs)** - `.opencode/docs/adrs/`
   - ADR-001: Adapter Pattern Abstraction (chose adapter pattern over 4 alternatives)
   - ADR-002: Cursor MCP First Target (chose Cursor MCP over Aider, Copilot)
   - ADR-003: Unified Configuration System (ToolConfig model, auto-detection)
   - ADR-004: Skills Refactoring Approach (3-layer: Definition → Executor → Renderer)
   - ADR-005: Backward Compatibility Strategy (zero breaking changes)

2. **Technical Design Documents** - `.opencode/docs/architecture/`
   - Part 1: ToolAdapter protocol (30+ methods), system architecture, ToolConfig model
   - Part 2: Skills architecture, ToolRegistry, data flows, testing strategy

3. **Cursor MCP PoC Specification**
   - Complete CursorAdapter implementation details
   - MCP server design (JSON-RPC 2.0 over stdio)

4. **Implementation Roadmap**
   - Detailed breakdown of 5 phases
   - Phase 1 (Size: XL): Adapter Foundation ← **START HERE**
   - Phase 2 (Size: XL): Cursor MCP Integration
   - Phase 3 (Size: L): Unified Configuration
   - Phase 4 (Size: L): Skills Refactoring
   - Phase 5 (Size: L): Testing & Polish

5. **Architecture README**
   - Comprehensive index to all documents
   - Quick start guide for Builders

### Current State

- **Branch:** main
- **Commits:** Architecture docs committed (commit 336f77f)
- **Tasks:** ARC-H-0030 marked COMPLETE
- **Tests:** All existing tests passing (100%)
- **No uncommitted changes**

### Key Architecture Decisions

**1. Adapter Pattern (3-Layer Architecture)**
```
Core (tool-agnostic) 
  ↓ depends on
ToolAdapter Protocol (abstraction)
  ↓ implemented by
Concrete Adapters (OpenCodeAdapter, CursorAdapter, AiderAdapter)
```

**2. Backward Compatibility (CRITICAL)**
- OpenCode is default (auto-detected via `.opencode/` directory)
- OpenCodeAdapter wraps existing code (thin wrapper, not rewrite)
- Zero breaking changes allowed
- All existing tests must pass (100%)
- Performance within 5% of v1.x.x baseline

**3. Tool Detection**
- ToolRegistry auto-detects active tool via directory markers
- `.opencode/` → OpenCodeAdapter (default)
- `.cursor/` → CursorAdapter
- `.aider/` → AiderAdapter

**4. Configuration**
- Tool-specific configs (opencode.json, cursor.json) normalized to ToolConfig
- PathResolver handles path mapping (.opencode/ → .cursor/, etc.)

**5. Skills Refactoring**
- skill.yaml format (workflow logic)
- SkillExecutor (executes tool-agnostic workflows)
- Tool-specific renderers (format output for each tool)

## What You Need to Do

### Primary Task: Implement Phase 1 - Adapter Foundation

**Size:** XL (Extra Large)  
**Goal:** Create foundation for tool-agnostic architecture

### Phase 1 Tasks Breakdown

**Task 1.1: Create ToolAdapter Protocol (Size: L)**
- File: `src/site_nine/adapters/__init__.py`
- File: `src/site_nine/adapters/protocol.py`
- Define Protocol class with 30+ abstract methods
- Full specifications in technical-design-document.md
- Type hints, docstrings for all methods

**Task 1.2: Implement OpenCodeAdapter (Size: XL)**
- File: `src/site_nine/adapters/opencode.py`
- Wraps existing OpenCode functionality (thin wrapper)
- Delegates to existing code in `src/site_nine/core/`, `src/site_nine/agents/`, etc.
- Must maintain 100% backward compatibility
- All existing tests must pass unchanged

**Task 1.3: Create ToolRegistry (Size: L)**
- File: `src/site_nine/adapters/registry.py`
- Auto-detects active tool via directory markers
- Returns appropriate adapter (OpenCodeAdapter by default)
- Handles adapter initialization and caching
- Error handling for missing/invalid tools

**Task 1.4: Implement PathResolver (Size: M)**
- File: `src/site_nine/adapters/path_resolver.py`
- Maps paths between tool conventions (.opencode/ → .cursor/, etc.)
- Respects tool-specific directory structures
- Backward compatible with existing path resolution

**Task 1.5: Write Unit Tests (Size: L)**
- Test suite for ToolAdapter protocol
- Test suite for OpenCodeAdapter (90%+ coverage)
- Test suite for ToolRegistry
- Test suite for PathResolver
- All tests must pass (100%)

**Task 1.6: Integration Testing (Size: M)**
- End-to-end tests with OpenCodeAdapter
- Verify existing .opencode/ projects work unchanged
- Performance benchmarks (compare to v1.x.x baseline)
- Backward compatibility validation
- End-to-end tests with OpenCodeAdapter
- Verify existing .opencode/ projects work unchanged
- Performance benchmarks (compare to v1.x.x baseline)
- Backward compatibility validation

**Task 1.7: Update Documentation (Size: M)**
- Docstrings for all new classes/methods
- Architecture README updates
- Code comments explaining adapter pattern
- Examples in technical design docs

### Approach

**1. Start with Protocol (Task 1.1)**
- Read: `.opencode/docs/architecture/technical-design-document.md`
- Create `src/site_nine/adapters/protocol.py`
- Define `ToolAdapter` Protocol class
- Copy method signatures from technical design doc
- Add type hints and docstrings

**2. Implement OpenCodeAdapter (Task 1.2)**
- **CRITICAL:** Thin wrapper, not rewrite
- Delegate to existing code:
  - `src/site_nine/core/paths.py` → path resolution
  - `src/site_nine/agents/sessions.py` → session management
  - `src/site_nine/tasks/manager.py` → task management
- Test frequently: all existing tests must pass

**3. Create ToolRegistry (Task 1.3)**
- Auto-detection logic: check for `.opencode/`, `.cursor/`, `.aider/` directories
- Default to OpenCodeAdapter if no tool detected
- Cache adapter instances (singleton pattern)

**4. Write Tests First (TDD)**
- Before implementing, write tests
- Define expected behavior in tests
- Implement until tests pass
- Target 90%+ coverage

**5. Validate Backward Compatibility**
- Run all existing tests after each task
- Performance benchmarks: within 5% of baseline
- Manual testing: existing `.opencode/` projects work unchanged

### Constraints

**CRITICAL - Zero Breaking Changes:**
- ✅ All existing tests must pass (100%)
- ✅ Existing `.opencode/` projects work unchanged
- ✅ OpenCodeAdapter is default (no config required)
- ✅ Performance within 5% of v1.x.x baseline
- ❌ No rewrites of existing code
- ❌ No changes to existing APIs
- ❌ No forced migrations

**Design Principles:**
- **Dependency Inversion:** Core depends on ToolAdapter protocol, not concrete adapters
- **Thin Wrapper:** OpenCodeAdapter delegates to existing code
- **Test-Driven Development:** Write tests before implementation
- **Incremental Refactoring:** Small, safe changes with continuous validation

**Testing Requirements:**
- 90%+ unit test coverage for new code
- 100% of existing tests must pass
- Integration tests for adapter operations
- Performance benchmarks within 5% of v1.x.x

## Files to Review (Reading Order)

**Start Here (Required - 1 hour):**

1. **Architecture README** (10 min)
   - `.opencode/docs/architecture/README.md`
   - Overview of entire architecture
   - Quick start guide for Builders

2. **ADR-001: Adapter Pattern** (5 min)
   - `.opencode/docs/adrs/ADR-001-adapter-pattern-abstraction.md`
   - Why adapter pattern was chosen

3. **ADR-005: Backward Compatibility** (5 min)
   - `.opencode/docs/adrs/ADR-005-backward-compatibility-strategy.md`
   - Critical constraints for implementation

4. **Technical Design Document Part 1** (20 min)
   - `.opencode/docs/architecture/technical-design-document.md`
   - Complete ToolAdapter protocol specification
   - OpenCodeAdapter implementation example
   - ToolConfig model specification

5. **Implementation Roadmap - Phase 1** (15 min)
   - `.opencode/docs/architecture/implementation-roadmap.md`
   - Detailed task breakdown for Phase 1
   - Acceptance criteria and success metrics

6. **Current Codebase** (10 min)
   - `src/site_nine/core/paths.py` - Understand existing path resolution
   - `src/site_nine/agents/sessions.py` - Session management
   - `src/site_nine/tasks/manager.py` - Task management

**Additional Context (Optional):**

7. **Other ADRs** - Cursor target, config system, skills refactoring
8. **Technical Design Part 2** - Skills architecture, data flows, testing
9. **Cursor MCP PoC Spec** - For Phase 2 (later)

## Important Context

### Based on Research from ADM-H-0029

- **80% of site-nine codebase is already tool-agnostic**
- Main coupling is in integration layer: skills, commands, config files
- Estimated full multi-tool support effort (all 5 phases): XXL

### Why Adapter Pattern?

From ADR-001, compared 5 alternatives:
- ✅ **Adapter Pattern** - Right-sized abstraction for 20% tool-coupled code
- ❌ Plugin Architecture - Over-engineering for this use case
- ❌ Tool-Specific Forks - Maintenance nightmare
- ❌ Configuration Templating - Too simple, doesn't scale
- ❌ Monolithic Conditionals - Code rot over time

### Why Cursor MCP First?

From ADR-002:
- MCP is open standard (not proprietary)
- Strong API surface for validation
- Large market opportunity
- Validates adapter pattern well

Rejected:
- Aider (too simple, not representative)
- GitHub Copilot CLI (closed, proprietary)
- Claude Code (not yet public)

### Testing Strategy

From technical-design-document-part2.md:

**Test Pyramid:**
- 70% Unit Tests - Test adapters, registry, resolvers in isolation
- 25% Integration Tests - Test adapter interactions with core
- 5% E2E Tests - Test full workflows (session start → work → session end)

**Backward Compatibility Tests:**
- Compare v1.x.x behavior vs v2.0.0 behavior
- All existing test suites must pass unchanged
- Performance benchmarks (within 5% of baseline)

### Error Handling

From technical-design-document-part2.md:

Exception hierarchy:
```python
SiteNineError
  ├─ ToolError
  │   ├─ ToolNotFoundError
  │   ├─ AdapterInitError
  │   └─ AdapterMethodNotImplementedError
  ├─ ConfigError
  │   ├─ ConfigNotFoundError
  │   └─ ConfigValidationError
  └─ SkillError
      ├─ SkillNotFoundError
      └─ SkillExecutionError
```

## Acceptance Criteria

Phase 1 is complete when:

### Code Deliverables
- [ ] `src/site_nine/adapters/protocol.py` - ToolAdapter protocol (30+ methods)
- [ ] `src/site_nine/adapters/opencode.py` - OpenCodeAdapter implementation
- [ ] `src/site_nine/adapters/registry.py` - ToolRegistry with auto-detection
- [ ] `src/site_nine/adapters/path_resolver.py` - PathResolver implementation

### Testing Deliverables
- [ ] Unit tests for all adapter components (90%+ coverage)
- [ ] Integration tests for adapter operations
- [ ] All existing tests pass (100%)
- [ ] Performance benchmarks within 5% of v1.x.x baseline

### Documentation Deliverables
- [ ] Docstrings for all new classes/methods
- [ ] Code comments explaining adapter pattern
- [ ] Updated architecture README if needed

### Validation
- [ ] Existing `.opencode/` projects work unchanged
- [ ] OpenCode is default (auto-detected)
- [ ] No breaking changes to existing APIs
- [ ] Code passes `make qa` (linting, type checking)

## Next Steps After Phase 1

Once Phase 1 is complete:

1. **Hand off to Architect for review** (optional)
2. **Proceed directly to Phase 2: Cursor MCP Integration**
   - Implement CursorAdapter
   - Create MCP server (JSON-RPC 2.0 over stdio)
   - E2E tests with Cursor IDE
3. **Create cursor.json template**
4. **Validate PoC with real Cursor installation**

## Questions to Consider

### During Implementation

1. **Should I create a feature branch?**
   - YES - Create `feature/multi-tool-adapter-foundation`
   - Keeps main stable while implementing

2. **How should I structure commits?**
   - Small, focused commits per task
   - Follow conventional commits format
   - Include `[Agent: Builder - YourName]` in messages

3. **What if existing tests fail?**
   - STOP immediately - do not proceed
   - Analyze what broke
   - Fix OpenCodeAdapter to maintain backward compatibility
   - Never change existing tests to make them pass

4. **What if I find issues in the architecture?**
   - Document the issue
   - Propose alternative in PR comments
   - Optionally hand off to Architect for design revision
   - Don't block on perfection - implement as designed first

5. **Should I create implementation tasks in database?**
   - YES - Create tasks for each Phase 1 item (Tasks 1.1-1.7)
   - Use category: implementation
   - Use role: Builder
   - Reference this handoff in task descriptions

### Performance Considerations

1. **Adapter overhead** - Keep OpenCodeAdapter delegation lightweight
2. **Registry caching** - Cache adapter instances (don't recreate)
3. **Path resolution** - Optimize PathResolver for frequent calls
4. **Testing** - Run performance benchmarks early and often

## Related Resources

### Architecture Documents
- `.opencode/docs/architecture/README.md` - Start here
- `.opencode/docs/architecture/technical-design-document.md` - Protocol spec
- `.opencode/docs/architecture/technical-design-document-part2.md` - Testing strategy
- `.opencode/docs/architecture/implementation-roadmap.md` - Full 6-8 week plan

### ADRs
- `.opencode/docs/adrs/ADR-001-adapter-pattern-abstraction.md` - Why adapter pattern
- `.opencode/docs/adrs/ADR-005-backward-compatibility-strategy.md` - Critical constraints

### Current Codebase
- `src/site_nine/core/paths.py` - Existing path resolution
- `src/site_nine/agents/sessions.py` - Session management
- `src/site_nine/tasks/manager.py` - Task management

### Session Files
- `.opencode/work/sessions/2026-02-03.13:13:46.architect.ptah.session-start.md` - Architecture session
- `.opencode/work/tasks/ARC-H-0030.md` - Architecture task (COMPLETE)

## Contact & Support

### If You Need Clarification

**Architecture questions:**
- Review ADRs for rationale behind decisions
- Check technical design docs for detailed specs
- Ask Director to summon Architect (Ptah) for design questions

**Implementation questions:**
- Check implementation roadmap for task details
- Review existing codebase for patterns to follow
- Ask Director for clarification on requirements

**Testing questions:**
- Review testing strategy in technical-design-document-part2.md
- Check existing test suites for patterns
- Ensure 90%+ coverage for new code

### Success Metrics

**Phase 1 Success:**
- All Phase 1 tasks complete (Tasks 1.1-1.7)
- All acceptance criteria met
- 90%+ unit test coverage for new code
- 100% of existing tests pass
- Performance within 5% of v1.x.x baseline
- Code review approved (if required)

**Ready for Phase 2 when:**
- ToolAdapter protocol defined and documented
- OpenCodeAdapter implemented and tested
- ToolRegistry auto-detects OpenCode
- PathResolver handles .opencode/ paths
- All tests passing, performance validated

---

## Handoff Checklist

For the Builder agent starting this work:

### Initial Setup
- [ ] Read this handoff document completely
- [ ] Review architecture README (`.opencode/docs/architecture/README.md`)
- [ ] Read ADR-001 (adapter pattern) and ADR-005 (backward compat)
- [ ] Review technical design document Part 1 (ToolAdapter protocol)
- [ ] Review implementation roadmap Phase 1 tasks
- [ ] Understand existing codebase (paths.py, sessions.py, tasks/manager.py)

### Task Creation
- [ ] Create task for 1.1: ToolAdapter Protocol (8h)
- [ ] Create task for 1.2: OpenCodeAdapter (16h)
- [ ] Create task for 1.3: ToolRegistry (12h)
- [ ] Create task for 1.4: PathResolver (8h)
- [ ] Create task for 1.5: Unit Tests (16h)
- [ ] Create task for 1.6: Integration Tests (8h)
- [ ] Create task for 1.7: Documentation (12h)

### Implementation
- [ ] Create feature branch: `feature/multi-tool-adapter-foundation`
- [ ] Implement Task 1.1 (ToolAdapter Protocol)
- [ ] Implement Task 1.2 (OpenCodeAdapter) - maintain backward compatibility!
- [ ] Implement Task 1.3 (ToolRegistry)
- [ ] Implement Task 1.4 (PathResolver)
- [ ] Implement Task 1.5 (Unit Tests) - achieve 90%+ coverage
- [ ] Implement Task 1.6 (Integration Tests) - validate backward compat
- [ ] Implement Task 1.7 (Documentation) - docstrings & comments

### Validation
- [ ] All existing tests pass (100%)
- [ ] New unit tests achieve 90%+ coverage
- [ ] Integration tests validate adapter operations
- [ ] Performance benchmarks within 5% of baseline
- [ ] Existing `.opencode/` projects work unchanged
- [ ] Code passes `make qa` (linting, type checking)

### Completion
- [ ] Mark all Phase 1 tasks as COMPLETE
- [ ] Update handoff status to `.completed.md`
- [ ] Create PR for feature branch (if using PRs)
- [ ] Hand off to Phase 2 or Architect for review

---

**Handoff Status:** pending  
**Created By:** Ptah (Architect)  
**Created At:** 2026-02-03 13:41:40  
**Size:** XL (7 tasks: 3 Large, 3 Medium, 1 Extra Large)  
**Priority:** HIGH

**This handoff represents the Architecture phase (Size: L). The implementation phase is Size: XXL total across 5 phases, with Phase 1 being XL.**
