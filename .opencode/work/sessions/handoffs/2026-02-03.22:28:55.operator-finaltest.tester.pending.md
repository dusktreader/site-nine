# Handoff: UUID-based Session Detection Testing

**From:** Operator (Finaltest)  
**To:** Tester (any)  
**Date:** 2026-02-03 22:28:55  
**Status:** PENDING  
**Task:** TST-H-0052  

---

## Context

### What Was Done

The UUID-based session detection feature has been fully implemented to solve the "wrong session renamed" problem when multiple OpenCode sessions are active concurrently.

**Implementation Summary:**
1. Created `generate-session-uuid` command that outputs unique session markers
2. Modified `_detect_session_via_uuid_marker()` to search OpenCode's part files (not session diffs)
3. Updated `_find_opencode_storage()` to return part_storage path
4. Integrated UUID detection as primary method in `rename-tui --uuid-marker` command

**Files Modified:**
- `src/site_nine/cli/mission.py` (renamed from agent.py):
  - `_detect_session_via_uuid_marker()` (lines 356-455) - searches `~/.local/share/opencode/storage/part/` files for UUID
  - `_find_opencode_storage()` (lines 336-355) - returns 3 paths including part_storage
  - `rename_tui()` (lines 1026+) - passes part_storage to detection, handles UUID marker
  - `generate_session_uuid()` (lines 899-956) - generates UUIDs like `session-marker-abc123`

- `.opencode/skills/session-start/SKILL.md`:
  - Added Step 6: Generate Session UUID Marker
  - Updated Step 7: Rename OpenCode TUI Session with UUID approach

**Testing Performed:**
- Generated multiple UUIDs in same session
- Verified each `rename-tui --uuid-marker` correctly identified the session that generated that UUID
- Confirmed debug logs show `session_detected_via_uuid_marker`
- Verified package installation and CLI functionality

### Current State

**Git:**
- Branch: `main`
- Status: Multiple uncommitted changes including new `mission.py` file
- Key change: `agent.py` deleted, replaced by `mission.py`

**Uncommitted Files:**
- `src/site_nine/cli/mission.py` (NEW - UUID detection implementation)
- `.opencode/skills/session-start/SKILL.md` (MODIFIED - documents UUID workflow)
- Multiple task markdown files updated
- Project database files

**Package Status:**
- Package rebuilt and installed with `uv pip install -e .`
- CLI command working: `s9 mission generate-session-uuid`
- CLI command working: `s9 mission rename-tui --uuid-marker`

**Task Created:**
- TST-H-0052: "Verify UUID-based session detection works in production"
- Priority: HIGH
- Role: Tester
- Status: TODO

---

## What You Need to Do

### Primary Task

**Test the UUID-based session detection feature (TST-H-0052) to verify it works correctly with multiple concurrent OpenCode sessions.**

### Testing Approach

You need to perform **multi-session concurrency testing** to ensure the UUID detection reliably identifies the correct session:

1. **Setup Multiple Sessions:**
   - Open 2-3 OpenCode sessions in the same project directory
   - Each session should be clearly identifiable (different terminal windows/tabs)

2. **Generate UUIDs:**
   - In Session A: Run `s9 mission generate-session-uuid`, capture the UUID output
   - In Session B: Run `s9 mission generate-session-uuid`, capture a different UUID
   - (Optional) Session C: Run `s9 mission generate-session-uuid`

3. **Test Session Identification:**
   - In Session A: Run `s9 mission rename-tui TestA Tester --uuid-marker <UUID_FROM_A>`
   - Verify: Session A title changed (not B or C)
   - In Session B: Run `s9 mission rename-tui TestB Tester --uuid-marker <UUID_FROM_B>`
   - Verify: Session B title changed (not A or C)

4. **Test Edge Cases:**
   - Old UUID (from 15+ minutes ago): Should fall back gracefully with warning message
   - Invalid UUID format: Should handle gracefully
   - UUID from different project: Should not match current session

5. **Verify Logging:**
   - Check that debug logs show `session_detected_via_uuid_marker` when UUID is found
   - Verify fallback messages appear when UUID not found

### Constraints

- **Environment:** Requires OpenCode storage directory at `~/.local/share/opencode/storage/`
- **Timing:** Test UUID detection within 10 minutes of generation (detection window)
- **Project:** Must test in the site-nine project directory
- **Package:** Must have latest code installed (`uv pip install -e .`)

### Files to Review

1. **Implementation:**
   - `src/site_nine/cli/mission.py:356-455` - UUID detection logic
   - `src/site_nine/cli/mission.py:899-956` - UUID generation logic

2. **Documentation:**
   - `.opencode/skills/session-start/SKILL.md` - Workflow instructions
   - Task file: `.opencode/work/tasks/TST-H-0052.md` - Full test specification

3. **Testing Reference:**
   - Previous manual tests worked correctly (see Context section above)

---

## Important Context

### How UUID Detection Works

1. **Generation:** `s9 mission generate-session-uuid` outputs UUID like `session-marker-abc123`
2. **Capture:** OpenCode captures tool output in part files at `~/.local/share/opencode/storage/part/msg_*/prt_*.json`
3. **Detection:** `rename-tui --uuid-marker` searches part files for the UUID string in `.state.output` fields
4. **Verification:** Confirms session belongs to current project directory
5. **Result:** Returns session ID (e.g., `ses_xxx`) for the session that generated the UUID

### Key Technical Details

- **Part File Structure:**
  - Type: `"tool"` (contains tool outputs)
  - UUID location: `.state.output` field (string containing UUID)
  - Session ID: `.sessionID` field

- **Search Window:** 10 minutes (600 seconds) for recent part files

- **Fallback Chain:**
  1. UUID marker (most reliable)
  2. Git diff correlation (content-based)
  3. Timestamp-based (least reliable, warns about multiple sessions)

### Known Working Behavior

From manual testing today:
```bash
# Generate UUID
$ s9 mission generate-session-uuid
Session UUID: session-marker-9b76dfda491b4000

# Rename using UUID
$ s9 mission rename-tui FinalTest Operator --uuid-marker session-marker-9b76dfda491b4000
2026-02-03 22:27:01.613 | DEBUG | ... | session_detected_via_uuid_marker
✓ Renamed OpenCode session to Finaltest - Operator
```

### Potential Issues to Watch For

1. **Race Conditions:** If two sessions generate UUIDs within milliseconds, verify each is unique
2. **Part File Delays:** OpenCode may take a few seconds to write part files after command execution
3. **Wrong Session Renamed:** If this happens, the implementation is broken - file a bug report
4. **Project Mismatch:** Verify UUID doesn't match sessions in different projects

---

## Acceptance Criteria

**Test is successful when:**

- ✅ Generated UUIDs are unique across sessions
- ✅ `rename-tui --uuid-marker` correctly identifies the session that generated each UUID
- ✅ No "wrong session renamed" errors occur with 2+ concurrent sessions
- ✅ Debug logs show `session_detected_via_uuid_marker` when UUID is found
- ✅ Fallback works gracefully when UUID not found (shows warning message)
- ✅ UUID not found in different project sessions
- ✅ No race conditions or timing issues observed

**Documentation outcomes:**

- ✅ Test results documented in TST-H-0052 task notes
- ✅ Any bugs found are filed as new HIGH priority tasks
- ✅ Task TST-H-0052 closed with COMPLETE status

---

## Next Steps

1. **Claim the task:**
   ```bash
   s9 task claim TST-H-0052 --agent-name "YourTesterName"
   ```

2. **Review implementation files:**
   - Read `mission.py:356-455` to understand detection logic
   - Read `mission.py:899-956` to understand UUID generation

3. **Install latest code:**
   ```bash
   cd /Users/tucker.beck/src/dusktreader/site-nine
   uv pip install -e .
   ```

4. **Prepare test environment:**
   - Open 2-3 terminal windows/tabs
   - Navigate to project directory in each
   - Start OpenCode session in each window

5. **Execute test procedure:**
   - Follow the "Testing Approach" section above
   - Document results in task notes with `s9 task update`

6. **Close task when complete:**
   ```bash
   s9 task close TST-H-0052 --status COMPLETE --notes "Test results summary"
   ```

---

## Contact & Resources

**This Handoff:**
- From: Operator (Finaltest)
- Session: Current OpenCode session (see title)
- Task Created: TST-H-0052

**Related Tasks:**
- OPR-H-0050: "Implement UUID-based session detection for rename-tui command" (completed by previous agents)

**Documentation:**
- Session start workflow: `.opencode/skills/session-start/SKILL.md`
- Task details: `.opencode/work/tasks/TST-H-0052.md`
- Implementation: `src/site_nine/cli/mission.py`

**Testing Command Reference:**
```bash
# Generate UUID
s9 mission generate-session-uuid

# Rename with UUID
s9 mission rename-tui <name> <role> --uuid-marker <uuid>

# Check task status
s9 task show TST-H-0052

# Update task progress
s9 task update TST-H-0052 --notes "..." --actual-hours X.X

# Close task
s9 task close TST-H-0052 --status COMPLETE --notes "..."
```

---

**Questions?** Review the implementation files or check debug logs with structlog output.

**Good luck with testing!** This is a critical feature for multi-session workflows.
