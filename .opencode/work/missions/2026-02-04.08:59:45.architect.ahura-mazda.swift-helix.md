---
date: 2026-02-04
start_time: 08:59:45
end_time: in-progress
role: Architect
persona: ahura-mazda
codename: swift-helix
mission_id: 62
objective: Design agent messaging and coordination system
---

# Mission: Agent Messaging and Coordination Architecture

**Persona:** Ahura Mazda (Architect)  
**Date:** 2026-02-04  
**Duration:** 08:59:45 - 15:42 (~6.75 hours)  
**Status:** Complete

## Objective

Design comprehensive architecture for agent-to-agent messaging and coordination patterns to enable autonomous collaboration without Director bottleneck. Create ADRs and implementation tasks for Epic EPC-H-0004 (Multi-Tool Adapter System).

**Note:** Initially tasked with ARC-H-0057 (Design ToolAdapter protocol), but pivoted to prerequisite messaging/coordination system based on Director's guidance.

## Work Log

### 09:00 - Session Start
- Claimed task ARC-H-0057 (Design ToolAdapter protocol)
- Reviewed epic EPC-H-0004 context
- Discussed coordination needs for multi-tool adapter implementation

### 09:30 - Identified Prerequisite System
- Director identified need for agent messaging before multi-tool coordination
- Current gap: No way for agents to communicate without Director relay
- Decided to design messaging system first, then return to ToolAdapter

### 10:00 - ADR-008 Design Started
- Researched messaging patterns (conversations vs discussions)
- Designed two-tier system: Conversations (1-on-1) and Discussions (scoped groups)
- Debated Director's role: Observer vs Participant (Mission 0)
- Decided: Director observes messages, communicates via OpenCode chat only

### 11:30 - Schema Design
- Initial design: `message_reads` table for per-message tracking
- Director questioned: "Does per-message read tracking make sense for agents?"
- Excellent point! Agents are stateless, don't need accountability like humans
- Pivoted to simpler `conversation_views` table with `last_viewed_at`

### 12:00 - Conversation View Tracking
- Designed conversation-level tracking instead of per-message
- "Unread" = messages created after `last_viewed_at`
- Simpler semantics: "What needs my attention?" not "Who saw MSG-123?"
- Added Alternative 5 to ADR documenting rejected per-message approach

### 13:00 - ADR-009 Design Started
- Agent Coordination Patterns: How agents discover help and coordinate
- Three mission scopes: task-scoped / epic-scoped / general (mutually exclusive)
- Desk mode: Non-blocking monitoring with 30s status output
- Agent remains in OpenCode chat to talk to Director between checks

### 14:00 - Communication Channels Clarity
- Three distinct channels:
  1. Agent ↔ Director: OpenCode chat (synchronous)
  2. Agent ↔ Agent: Messaging system (asynchronous)
  3. Director → Messages: Observation only (read-only)
- Director is NOT Mission 0, doesn't send/receive messages

### 14:30 - Rollback Plan Added
- Director requested rollback plan for messaging system
- Created 4-phase rollback: Disable, Archive, Cleanup, Remove
- Defined triggers: low adoption, high confusion, performance issues
- Included pivot option: simplified messaging (remove discussions/threading)

### 15:00 - ADRs Approved
- ADR-008: Agent Messaging System - ACCEPTED
- ADR-009: Agent Coordination Patterns - ACCEPTED
- Both ADRs updated to ACCEPTED status

### 15:30 - Implementation Tasks Created
- Created Epic EPC-H-0005: Agent Messaging and Coordination System
- Created 28 implementation tasks across 4 phases:
  - Phase 1: Messaging Core (9 HIGH tasks)
  - Phase 1: Mission Scoping (6 HIGH tasks)
  - Phase 2: Mission Discovery (4 MEDIUM tasks)
  - Phase 3: Desk Mode (5 MEDIUM tasks)
  - Phase 4: Skills & Documentation (4 MEDIUM tasks)
- Tasks assigned to: Operator (19), Tester (5), Documentarian (4)

### 15:42 - Mission End Protocol
- Started session-end skill
- Gathered work summary
- Creating mission file

## Files Changed

### Created
- `.opencode/docs/adrs/ADR-008-agent-messaging-system.md` - Agent messaging system architecture (845 lines)
- `.opencode/docs/adrs/ADR-009-agent-coordination-patterns.md` - Agent coordination patterns (560 lines)
- `.opencode/work/epics/EPC-H-0005.md` - Agent Messaging and Coordination System epic
- `.opencode/work/messaging-system-erd.mmd` - Mermaid ERD diagram for messaging schema
- 28 task files: OPR-H-0082 through DOC-M-0109

### Modified
- `.opencode/data/project.db` - Epic and task creation

## Outcomes

### Architecture Design
- ✅ Designed two-tier messaging: Conversations (1-on-1) and Discussions (scoped groups)
- ✅ Simplified from per-message to conversation-level view tracking
- ✅ Clarified Director role: Observer only, NOT Mission 0
- ✅ Defined three communication channels (Agent↔Director, Agent↔Agent, Director→Messages)
- ✅ Designed mission scoping: task/epic/general (mutually exclusive)
- ✅ Designed desk mode: non-blocking monitoring with 30s status output
- ✅ Created comprehensive rollback plan

### Documentation
- ✅ ADR-008: Agent Messaging System (ACCEPTED) - 845 lines
- ✅ ADR-009: Agent Coordination Patterns (ACCEPTED) - 560 lines
- ✅ Both ADRs include alternatives considered, consequences, implementation plans
- ✅ Both ADRs wrapped to 120 characters per Director's style preference

### Implementation Planning
- ✅ Created Epic EPC-H-0005 with full description
- ✅ Created 28 implementation tasks with clear descriptions and ADR references
- ✅ Tasks organized into 4 phases with appropriate priorities
- ✅ Tasks distributed across Operator (implementation), Tester (validation), Documentarian (skills)

## Key Design Decisions

1. **Conversation-level tracking** over per-message reads (simplicity for agents)
2. **Director as observer** not participant (separate communication channel)
3. **Dynamic scoping** for discussions (role/epic/all computed at query time)
4. **Non-blocking desk mode** (agent stays in chat, periodic status output)
5. **Mutually exclusive mission scoping** (task XOR epic, not both)

## Next Steps

### For Epic EPC-H-0005
- Operator should start with Phase 1 HIGH priority tasks
- Schema migrations first (OPR-H-0082, OPR-H-0091, OPR-M-0101)
- Then core functionality (MessageManager, CLI commands)
- Testing after each phase

### For Task ARC-H-0057
- Deferred: Design ToolAdapter protocol
- Should be resumed after messaging system basics are implemented
- ToolAdapter will benefit from having messaging/coordination available

### Dependencies
- OPR-M-0074 (JSON output flag) - needed for mission discovery
- All tasks reference specific ADR sections for implementation guidance

## Notes

- Mission started with continuation from previous context
- Extensive discussion with Director about design choices
- Multiple iterations on schema (message_reads → conversation_views)
- Rollback plan added upon Director's request
- ADRs approved and status updated to ACCEPTED
- Epic and all tasks created successfully

## Reflection

This mission demonstrates the value of:
1. **Questioning assumptions** - "Does read tracking make sense?" led to simpler design
2. **Clear separation of concerns** - Three distinct communication channels
3. **Planning for failure** - Comprehensive rollback plan
4. **Detailed implementation guidance** - 28 tasks with ADR references

The messaging and coordination system will be a significant enhancement to site-nine, enabling true agent autonomy and collaboration.
