# Task OPR-H-0005: Consolidate and reorganize .opencode directory structure

**Status:** UNDERWAY
**Priority:** HIGH
**Role:** Operator
**Category:** infrastructure
**Agent:** cronos
**Claimed:** 2026-02-02 04:46:45
**Actual Time:** 
**Closed:** 
**Paused:** 


## Objective

Restructure .opencode directory to clearly separate prompts/instructions, tracking documents, and data storage

Reorganize .opencode/ to create clear separation between: (1) Prompts/Instructions/Static Docs - agent definitions, guides, procedures that don't change during work (e.g., agents/, guides/, procedures/); (2) Tracking Documents - files updated during development like PROJECT_STATUS.md, session files, task artifacts that track work in progress; (3) Data Storage - databases, caches, non-document files like project.db. Propose new directory structure with clear naming and purpose. Create migration plan for moving existing files. Update all references in code and documentation. Consider directories like: .opencode/prompts/, .opencode/tracking/, .opencode/data/, or similar clear naming. Document the new structure in README.md with clear guidelines on what goes where.

---

## Problem Statement

The current `.opencode/` directory structure mixes static instructions, tracking documents, and data storage at the same level, making it unclear where files belong and difficult to navigate:

**Current structure:**
```
.opencode/
├── agents/              # Static agent definitions
├── commands/            # Static command instructions
├── data/                # Database storage
├── guides/              # Static development guides
├── node_modules/        # Dependencies (should be gitignored)
├── planning/            # Both task artifacts AND PROJECT_STATUS.md (mixed purpose)
├── procedures/          # Static procedures
├── scripts/             # Empty utility directory
├── sessions/            # Tracking - session logs
├── skills/              # Static skill workflows
└── README.md            # Static documentation
```

**Problems:**
1. **Mixed purposes:** Static files (agents/, guides/) at same level as tracking files (sessions/)
2. **Ambiguous naming:** "planning/" contains both active task artifacts and strategic planning docs
3. **Poor organization:** No clear hierarchy or grouping by purpose
4. **Unclear placement:** Where should new types of documents go?
5. **Non-obvious structure:** New users don't immediately understand the organization

**Impact:**
- Harder to find files
- Unclear where to create new documents
- Confusing for both humans and AI agents
- Not scalable as more document types are added

---

## Proposed Solution

### Selected Approach: Option A (Modified) - Semantic Organization

**New structure:**
```
.opencode/
├── docs/                    # Static instructions (was: agents/, commands/, guides/, procedures/, skills/)
│   ├── agents/              # Agent role definitions
│   ├── commands/            # Slash command instructions
│   ├── guides/              # Development guides
│   ├── procedures/          # Operational procedures
│   ├── skills/              # Reusable skill workflows
│   └── README.md            # Documentation overview
│
├── work/                    # Tracking documents (was: sessions/, planning/)
│   ├── sessions/            # Agent session logs
│   │   └── handoffs/        # Handoff documents
│   ├── tasks/               # Task artifacts
│   ├── planning/            # Strategic planning (PROJECT_STATUS.md)
│   └── README.md            # Work tracking overview
│
├── data/                    # Data storage (unchanged)
│   └── project.db           # SQLite database
│
├── scripts/                 # Utility scripts (unchanged)
│
├── .gitignore               # Git config (add node_modules)
├── opencode.json            # OpenCode configuration
├── package.json             # OpenCode package
└── README.md                # Main documentation
```

**User Decision:** Changed `prompts/` to `docs/` (more intuitive name)

**Rationale:**
- Clear semantic categories: `docs/` (read), `work/` (track), `data/` (store)
- Minimal disruption: only creates 2 new top-level directories
- Scalable: easy to add new subdirectories within each category
- Developer-friendly: names immediately communicate purpose
- Maintains OpenCode integration: config files stay at root

---

## Code Changes Required

**CRITICAL:** This migration has TWO parts:
1. Update `s9` initialization code (so future projects use new structure)
2. Migrate current `.opencode/` directory

### Part 1: Update s9 Code (src/s9/)

#### File 1: `src/s9/cli/init.py` (Lines 70, 92-129, 170)

**Line 70 - Update console message:**
```python
# FROM:
console.print("  2. Customize agent roles in .opencode/agents/")
# TO:
console.print("  2. Customize agent roles in .opencode/docs/agents/")
```

**Lines 92-129 - Update template mappings:**
```python
template_mappings = {
    "base/README.md.jinja": "README.md",
    "base/opencode.json.jinja": "opencode.json",
    # Agents - CHANGE paths
    "base/agents/manager.md.jinja": "docs/agents/manager.md",
    "base/agents/architect.md.jinja": "docs/agents/architect.md",
    "base/agents/builder.md.jinja": "docs/agents/builder.md",
    "base/agents/tester.md.jinja": "docs/agents/tester.md",
    "base/agents/documentarian.md.jinja": "docs/agents/documentarian.md",
    "base/agents/designer.md.jinja": "docs/agents/designer.md",
    "base/agents/inspector.md.jinja": "docs/agents/inspector.md",
    "base/agents/operator.md.jinja": "docs/agents/operator.md",
    # Guides - CHANGE paths
    "base/guides/AGENTS.md.jinja": "docs/guides/AGENTS.md",
    "base/guides/architecture.md.jinja": "docs/guides/architecture.md",
    "base/guides/design-philosophy.md.jinja": "docs/guides/design-philosophy.md",
    "base/guides/README.md.jinja": "docs/guides/README.md",
    # Procedures - CHANGE paths
    "base/procedures/COMMIT_GUIDELINES.md.jinja": "docs/procedures/COMMIT_GUIDELINES.md",
    "base/procedures/WORKFLOWS.md.jinja": "docs/procedures/WORKFLOWS.md",
    "base/procedures/TROUBLESHOOTING.md.jinja": "docs/procedures/TROUBLESHOOTING.md",
    "base/procedures/TASK_WORKFLOW.md.jinja": "docs/procedures/TASK_WORKFLOW.md",
    "base/procedures/README.md.jinja": "docs/procedures/README.md",
    # Planning - CHANGE path
    "base/planning/PROJECT_STATUS.md.jinja": "work/planning/PROJECT_STATUS.md",
    # Commands - CHANGE path
    "base/commands/README.md.jinja": "docs/commands/README.md",
    # Skills - CHANGE paths
    "base/skills/session-start/SKILL.md.jinja": "docs/skills/session-start/SKILL.md",
    "base/skills/session-start/daemon-names.md.jinja": "docs/skills/session-start/daemon-names.md",
    "base/skills/session-end/SKILL.md.jinja": "docs/skills/session-end/SKILL.md",
    "base/skills/handoff-workflow/SKILL.md.jinja": "docs/skills/handoff-workflow/SKILL.md",
    "base/skills/task-management/SKILL.md.jinja": "docs/skills/task-management/SKILL.md",
    "base/skills/tasks-report/SKILL.md.jinja": "docs/skills/tasks-report/SKILL.md",
    # Sessions - CHANGE path
    "base/sessions/README.md.jinja": "work/sessions/README.md",
    "base/sessions/TEMPLATE.md.jinja": "work/sessions/TEMPLATE.md",
}
```

**Line 140 - Update commands_dir:**
```python
# FROM:
commands_dir = output_dir / "commands"
# TO:
commands_dir = output_dir / "docs" / "commands"
```

**Line 170 - Update directory creation:**
```python
# FROM:
(output_dir / "planning").mkdir(exist_ok=True)
# TO:
(output_dir / "work" / "planning").mkdir(exist_ok=True, parents=True)
(output_dir / "work" / "tasks").mkdir(exist_ok=True, parents=True)
```

#### File 2: `src/s9/agents/sessions.py` (Line 51)

**Line 51 - Update session file path:**
```python
# FROM:
session_file = f".opencode/sessions/{date_str}.{time_str}.{role.lower()}.{name}.md"
# TO:
session_file = f".opencode/work/sessions/{date_str}.{time_str}.{role.lower()}.{name}.md"
```

#### File 3: `src/s9/tasks/manager.py` (Line 94)

**Line 94 - Update task artifact path:**
```python
# FROM:
file_path = f".opencode/planning/{task_id}.md"
# TO:
file_path = f".opencode/work/tasks/{task_id}.md"
```

#### Directory: `src/s9/templates/base/`

**Reorganize template directory structure:**

**Current:**
```
base/
├── agents/
├── commands/
├── data/
├── guides/
├── planning/
├── procedures/
├── scripts/
├── sessions/
├── skills/
├── README.md.jinja
└── opencode.json.jinja
```

**New:**
```
base/
├── docs/
│   ├── agents/
│   ├── commands/
│   ├── guides/
│   ├── procedures/
│   └── skills/
├── work/
│   ├── sessions/
│   └── planning/
├── data/
├── scripts/
├── README.md.jinja
└── opencode.json.jinja
```

**Actions:**
1. Create `docs/` and `work/` subdirectories
2. Use `git mv` to move directories (preserves history)
3. Update template references in init.py

---

## Implementation Steps

### 2026-02-01 20:46:45 - Task Claimed
- Agent Cronos claimed task OPR-H-0005
- Started analysis of current structure

### 2026-02-01 20:48:00 - Analysis Complete
- Identified 4 categories of files in `.opencode/`
- Listed 5 problems with current structure
- Proposed 3 reorganization options

### 2026-02-01 20:49:00 - User Decision
- User selected Option A (Semantic Organization)
- User requested modification: `prompts/` → `docs/`
- Final structure: `docs/`, `work/`, `data/`, `scripts/`

### 2026-02-01 20:50:00 - Code Changes Identified
- Discovered this requires updating s9 initialization code
- Found 3 Python files need path updates
- Found template directory needs reorganization
- Identified this as TWO-part migration (code first, then directory)

### 2026-02-01 20:52:00 - Task Artifact Updated
- Added detailed code changes section
- Added implementation plan with 5 phases
- Added testing checklist
- Added acceptance criteria

### 2026-02-01 20:55:00 - User Reminder to Wait
- User correctly stopped premature implementation
- One small code change was made (init.py line 70 comment)
- User requested handoff to another operator

### 2026-02-01 20:56:15 - Handoff Created
- Created handoff document for next operator
- Handoff file: `.opencode/sessions/handoffs/2026-02-01.20:56:15.operator-cronos.operator.pending.md`
- Updated session file with handoff details

### 2026-02-01 21:05:00 - Corrected Handoff
- User pointed out handoff was incomplete
- Realized task artifact (OPR-H-0005.md) was never properly created
- Properly filling out task artifact now with complete analysis and plan

---

## Migration Plan

### Phase 1: Update s9 Code (DO FIRST)
1. Update `src/s9/cli/init.py`:
   - Line 70: Update console message
   - Lines 92-129: Update all template path mappings
   - Line 140: Update commands_dir path
   - Line 170: Update directory creation for work/planning/ and work/tasks/
2. Update `src/s9/agents/sessions.py`:
   - Line 51: Change session path to work/sessions/
3. Update `src/s9/tasks/manager.py`:
   - Line 94: Change task artifact path to work/tasks/
4. Reorganize `src/s9/templates/base/`:
   - Create docs/ directory
   - Move agents/, commands/, guides/, procedures/, skills/ into docs/
   - Create work/ directory  
   - Move sessions/, planning/ into work/
   - Use `git mv` to preserve history
5. Test in temporary directory:
   ```bash
   mkdir /tmp/test-s9-init
   cd /tmp/test-s9-init
   s9 init
   # Verify structure has docs/, work/, data/, scripts/
   ```
6. Commit code changes:
   ```bash
   git add src/s9/
   git commit -m "refactor(s9): reorganize .opencode to docs/ and work/ structure

   - Move static instructions to docs/ (agents, commands, guides, procedures, skills)
   - Move tracking documents to work/ (sessions, tasks, planning)
   - Update init.py template mappings
   - Update sessions.py session file path
   - Update manager.py task artifact path
   - Reorganize template directory structure
   
   BREAKING CHANGE: s9 init now creates .opencode/docs/ and .opencode/work/
   instead of top-level directories. Existing projects need manual migration."
   ```

### Phase 2: Migrate Current .opencode/
1. Create new directory structure:
   ```bash
   mkdir -p .opencode/docs
   mkdir -p .opencode/work/sessions/handoffs
   mkdir -p .opencode/work/tasks
   mkdir -p .opencode/work/planning
   ```
2. Move files (use git mv):
   ```bash
   # Move to docs/
   git mv .opencode/agents .opencode/docs/
   git mv .opencode/commands .opencode/docs/
   git mv .opencode/guides .opencode/docs/
   git mv .opencode/procedures .opencode/docs/
   git mv .opencode/skills .opencode/docs/
   
   # Move sessions/ to work/
   git mv .opencode/sessions .opencode/work/
   
   # Move task artifacts to work/tasks/
   git mv .opencode/planning/*.md .opencode/work/tasks/
   
   # Move PROJECT_STATUS.md to work/planning/
   git mv .opencode/work/tasks/PROJECT_STATUS.md .opencode/work/planning/ 2>/dev/null || true
   
   # Remove old empty planning directory
   rmdir .opencode/planning
   ```
3. Update `.opencode/.gitignore`:
   ```
   node_modules/
   data/project.db
   ```
4. Update `.opencode/README.md` with new structure documentation
5. Test all functionality:
   - Test `/summon` creates session in work/sessions/
   - Test skill loading from docs/skills/
   - Test task creation in work/tasks/
   - Verify database access from data/project.db
6. Commit migration:
   ```bash
   git add .opencode/
   git commit -m "refactor(.opencode): migrate to docs/ and work/ structure

   - Move static docs to docs/ directory
   - Move tracking docs to work/ directory  
   - Update .gitignore to exclude node_modules
   - Update README.md with new structure"
   ```

### Phase 3: Mark Task Complete
1. Update task status to COMPLETE
2. Close handoff document
3. Update session file

---

## Files Changed

### Created
- `.opencode/sessions/handoffs/2026-02-01.20:56:15.operator-cronos.operator.pending.md` - Handoff document
- (Will create) `.opencode/docs/` - New directory for static documentation
- (Will create) `.opencode/work/` - New directory for tracking documents

### Modified
- `src/s9/cli/init.py` - Template mappings and directory creation (partially modified line 70)
- (Will modify) `src/s9/agents/sessions.py` - Session file path
- (Will modify) `src/s9/tasks/manager.py` - Task artifact path
- (Will modify) `.opencode/README.md` - Structure documentation
- (Will modify) `.opencode/.gitignore` - Add node_modules exclusion

### Moved
- (Will move) All files from `agents/`, `commands/`, `guides/`, `procedures/`, `skills/` → `docs/`
- (Will move) All files from `sessions/` → `work/sessions/`
- (Will move) All task artifacts from `planning/` → `work/tasks/`
- (Will move) `PROJECT_STATUS.md` from `planning/` → `work/planning/`

---

## Testing Performed

### Pre-Implementation Testing
- Analyzed current directory structure (verified file counts and locations)
- Reviewed existing task ID format (confirmed OPR-H-0005 is correct)
- Checked git status (verified uncommitted changes)

### Testing Required After Code Changes
- [ ] Test `s9 init` in temporary directory
- [ ] Verify new structure created correctly
- [ ] Verify template files copied to right locations
- [ ] Verify all agent files in docs/agents/
- [ ] Verify all skills in docs/skills/

### Testing Required After Migration
- [ ] Test `/summon` command
- [ ] Test skill loading
- [ ] Test task creation
- [ ] Test handoff creation
- [ ] Verify database access
- [ ] Check git history preserved

---

## Notes

### Progress Notes
- **Planning complete:** Full analysis and plan documented
- **User decision recorded:** Option A with docs/ instead of prompts/
- **Code changes identified:** 3 Python files + templates
- **Migration plan created:** 3 phases with detailed steps
- **Handed off:** Waiting for next operator to implement

### Blockers
- Waiting for user confirmation that other agents have finished their work
- One premature code change made (init.py line 70) - needs to be part of full update

### Questions
- Should we create a migration script for existing projects?
- Should we add detection to warn if project uses old structure?
- Should we document this as breaking change in changelog?

### Important Reminders
- **Order matters:** Code changes MUST come before directory migration
- **Use git mv:** Preserves file history
- **Test thoroughly:** Both code init and migration need verification
- **Breaking change:** This affects all future s9 init projects
- **This file will move:** From planning/ to work/tasks/ during migration

---

## 2026-02-02 Follow-Up: Commands and Skills Moved to Top-Level

**Agent:** Cernunnos (Operator)  
**Commit:** `3d68335`

After completing the initial docs/work/ reorganization, user requested a follow-up change to move `commands/` and `skills/` out of `docs/` and up to top-level, as they are infrastructure/configuration rather than documentation.

### Final Structure

```
.opencode/
├── commands/       # Slash command definitions (TOP-LEVEL)
├── skills/         # Reusable skill workflows (TOP-LEVEL)
├── docs/           # Pure documentation (agents, guides, procedures)
├── work/           # Tracking documents (sessions, tasks, planning)
├── data/           # Database storage
└── scripts/        # Utilities
```

### Changes Made
- Moved template directories: `base/docs/{commands,skills}/` → `base/{commands,skills}/`
- Updated init.py template mappings and commands_dir path
- Updated opencode.json.jinja paths for skills and commands
- Updated command template files (summon.md, dismiss.md, handoff.md)
- Updated documentation references (COMMAND-FIX-SUMMARY.md, TROUBLESHOOTING.md)
- Moved current .opencode/ directories to top-level
- Updated .opencode/opencode.json skills path
- Tested s9 init - creates correct structure

This provides clearer separation: commands and skills are infrastructure, docs contains only documentation.
