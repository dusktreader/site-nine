# Task OPR-M-0045: Fix site_nine module import errors during session startup

**Status:** TODO
**Priority:** MEDIUM
**Role:** Operator
**Category:** fix
**Agent:** 
**Claimed:** 
**Actual Time:** 
**Closed:** 
**Paused:** 

## Objective

Fix import errors that occur during session startup when `s9` commands fail because the `site_nine` module is not available. Add proper error handling, detection, and guidance in both the session-start skill and the `s9` CLI wrapper, plus update setup documentation.

## Problem Statement

During session startup, users (especially on the site-nine project itself) encounter errors like:

```
ModuleNotFoundError: No module named 's9'
ModuleNotFoundError: No module named 'site_nine'
```

This happens because:

1. **On site-nine development (this project):**
   - The `site_nine` module needs to be installed in editable mode: `uv sync` or `pip install -e .`
   - If not installed, Python can't import the module even though the source code is present
   - Session-start skill tries to run `s9` commands which fail

2. **On other projects/machines:**
   - The `site_nine` package should be installed normally: `pip install site-nine` or `uv add site-nine`
   - If not installed, same error occurs

3. **Confusing error messages:**
   - Error says "No module named 's9'" but `s9` is not the module name, it's the CLI executable
   - Users don't get clear guidance on how to fix the issue
   - Skill doesn't gracefully handle the failure

The session-start skill tries commands like:
```bash
s9 dashboard
s9 name suggest Operator --count 3
s9 agent start hauhet --role Operator
```

All of these fail silently or with cryptic errors if site_nine isn't installed.

## Requirements

### Must Have

1. **Better error messages in session-start skill:**
   - When `s9` command fails, detect if it's due to missing module
   - Show clear error message explaining the issue
   - Provide fix instructions based on context (site-nine dev vs. other project)
   - Gracefully degrade (continue session without database features if possible)

2. **Installation detection in s9 CLI wrapper:**
   - Create a wrapper script or entry point check that verifies site_nine is importable
   - If not importable, show helpful error before trying to execute
   - Error should distinguish between:
     - "You're working on site-nine itself, run `uv sync` to install in editable mode"
     - "site-nine is not installed, run `pip install site-nine` or `uv add site-nine`"

3. **Updated setup documentation:**
   - `.opencode/README.md` - Add setup instructions for developing site-nine
   - `.opencode/docs/guides/SETUP.md` (if exists) - Add troubleshooting section
   - Main `README.md` - Ensure development setup is clear
   - Include common errors and solutions

4. **Graceful degradation in skills:**
   - If database commands aren't available, skill should still work
   - Fall back to manual workflows or simplified flows
   - Don't break the entire session startup because of one failed command

### Should Have

- Environment detection (detect if in site-nine repo vs. external project)
- Pre-flight check command: `s9 doctor` that verifies installation
- Automatic fix suggestions (e.g., "Run this command to fix: uv sync")
- Warning in session-start if running without database features

### Nice to Have

- Auto-install detection and prompt
- Better integration with uv/pip for automatic setup
- Health check at skill start

## Implementation Steps

### Phase 1: Improve s9 CLI Entry Point

**1.1 Create installation check helper:**

```python
# src/site_nine/cli/_check.py
import sys
from pathlib import Path

def check_installation():
    """
    Verify site_nine is properly installed.
    Returns (is_installed: bool, error_message: str | None, fix_command: str | None)
    """
    try:
        import site_nine
        return (True, None, None)
    except ImportError:
        # Detect if we're in site-nine repo
        cwd = Path.cwd()
        is_site_nine_repo = (cwd / "pyproject.toml").exists() and \
                           (cwd / "src" / "site_nine").exists()
        
        if is_site_nine_repo:
            error = """
site_nine module is not installed in editable mode.

You are working in the site-nine repository, but the package is not installed.
This is required for the CLI to work.
"""
            fix = "uv sync  # or: pip install -e ."
        else:
            error = """
site_nine is not installed.

The s9 CLI requires the site_nine package to be installed.
"""
            fix = "pip install site-nine  # or: uv add site-nine"
        
        return (False, error, fix)

def check_or_exit():
    """Check installation and exit with helpful message if not installed."""
    is_installed, error, fix = check_installation()
    if not is_installed:
        print(error, file=sys.stderr)
        print(f"\nTo fix this, run:\n  {fix}\n", file=sys.stderr)
        sys.exit(1)
```

**1.2 Update CLI entry point to check on startup:**

```python
# src/site_nine/cli/__init__.py
import typer
from site_nine.cli._check import check_or_exit

app = typer.Typer(...)

def main():
    """Main CLI entry point with installation check."""
    check_or_exit()  # This will exit if not properly installed
    app()

if __name__ == "__main__":
    main()
```

**1.3 Update pyproject.toml entry points:**

```toml
[project.scripts]
s9 = "site_nine.cli:main"
```

Ensure this points to the wrapper that includes the check.

### Phase 2: Update session-start Skill

**2.1 Add error handling for s9 commands:**

Modify `.opencode/skills/session-start/SKILL.md`:

```markdown
## Important: CLI Tool Availability

**CRITICAL:** This skill uses the `s9` CLI tool throughout. Before proceeding, verify it's available:

```bash
s9 --version
```

**If this command fails:**

1. **If you're working ON the site-nine project itself:**
   - The site_nine module must be installed in editable mode
   - Run: `uv sync` (or `pip install -e .`)
   - Then retry: `s9 --version`

2. **If you're working on a different project:**
   - The site-nine package must be installed
   - Run: `pip install site-nine` (or `uv add site-nine`)
   - Then retry: `s9 --version`

**If s9 is not available and cannot be installed:**
- Skip all `s9` commands in this skill
- Use manual workflows (create session file manually, skip database registration)
- Inform the Director that database features are unavailable
```

**2.2 Add fallback behavior for failed commands:**

Wrap critical commands in error checking:

```markdown
## Step 1: Show Current Project Status

Run the project dashboard:

```bash
s9 dashboard || echo "⚠️  Dashboard unavailable (s9 not installed)"
```

If the command fails, inform the Director:
```
⚠️  **Project dashboard unavailable**

The `s9` CLI tool is not properly installed. Continuing with simplified session startup.

Some features will be unavailable:
- Project dashboard
- Database-backed task tracking  
- Automated daemon name management
- Session registration

You can still work, but session won't be tracked in the database.
```
```

**2.3 Update all s9 command invocations:**

Add `|| true` or proper error handling to each:
- `s9 dashboard || [handle error]`
- `s9 name suggest || [handle error]`
- `s9 agent start || [handle error]`
- etc.

### Phase 3: Add s9 doctor Command

**3.1 Create diagnostic command:**

```python
# src/site_nine/cli/doctor.py
import typer
from rich.console import Console
from rich.panel import Panel
from pathlib import Path
import sys

app = typer.Typer(help="Diagnose site-nine installation and configuration")
console = Console()

@app.command()
def check():
    """Run diagnostic checks on site-nine installation"""
    
    checks = []
    all_passed = True
    
    # Check 1: Module importable
    try:
        import site_nine
        checks.append(("✓", "site_nine module is importable"))
    except ImportError:
        checks.append(("✗", "site_nine module CANNOT be imported"))
        all_passed = False
    
    # Check 2: Database accessible
    try:
        from site_nine.core.database import Database
        db = Database()
        with db.get_session():
            checks.append(("✓", "Database connection works"))
    except Exception as e:
        checks.append(("✗", f"Database connection failed: {e}"))
        all_passed = False
    
    # Check 3: In site-nine repo?
    cwd = Path.cwd()
    is_site_nine_repo = (cwd / "pyproject.toml").exists() and \
                       (cwd / "src" / "site_nine").exists()
    if is_site_nine_repo:
        checks.append(("ℹ", "Working in site-nine repository"))
        
        # Check if installed in editable mode
        try:
            import site_nine
            site_nine_path = Path(site_nine.__file__).parent
            if site_nine_path.is_relative_to(cwd):
                checks.append(("✓", "Installed in editable mode"))
            else:
                checks.append(("⚠", "Not installed in editable mode (recommended for development)"))
        except:
            pass
    else:
        checks.append(("ℹ", "Working in external project"))
    
    # Check 4: CLI entry point
    import shutil
    if shutil.which("s9"):
        checks.append(("✓", "s9 CLI is in PATH"))
    else:
        checks.append(("✗", "s9 CLI is NOT in PATH"))
        all_passed = False
    
    # Display results
    console.print("\n[bold]site-nine Installation Diagnostics[/bold]\n")
    for symbol, message in checks:
        console.print(f"{symbol} {message}")
    
    if all_passed:
        console.print("\n[green]✓ All checks passed![/green]\n")
    else:
        console.print("\n[red]✗ Some checks failed. See above for details.[/red]\n")
        
        # Show fix suggestions
        if is_site_nine_repo:
            console.print(Panel(
                "To fix: run [bold]uv sync[/bold] or [bold]pip install -e .[/bold]",
                title="Suggested Fix",
                border_style="yellow"
            ))
        else:
            console.print(Panel(
                "To fix: run [bold]pip install site-nine[/bold] or [bold]uv add site-nine[/bold]",
                title="Suggested Fix", 
                border_style="yellow"
            ))
        
        sys.exit(1)
```

**3.2 Register doctor command:**

```python
# src/site_nine/cli/__init__.py
from site_nine.cli import doctor
app.add_typer(doctor.app, name="doctor")
```

### Phase 4: Update Documentation

**4.1 Update .opencode/README.md:**

Add section:
```markdown
## Development Setup (site-nine contributors)

If you're working on site-nine itself:

1. Clone the repository
2. Install in editable mode:
   ```bash
   uv sync
   # or
   pip install -e .
   ```
3. Verify installation:
   ```bash
   s9 --version
   s9 doctor
   ```

### Troubleshooting

**Error: `ModuleNotFoundError: No module named 'site_nine'`**

You need to install site-nine in editable mode:
```bash
uv sync  # or: pip install -e .
```

**Error: `command not found: s9`**

The CLI entry point is not in your PATH. After installing, you may need to:
- Restart your shell
- Activate your virtual environment: `source .venv/bin/activate`
- Or use: `uv run s9` instead of `s9`
```

**4.2 Update main README.md:**

Ensure development setup is documented clearly at the top.

**4.3 Create troubleshooting guide:**

`.opencode/docs/guides/TROUBLESHOOTING.md`:
```markdown
# Troubleshooting Guide

## Import Errors

### ModuleNotFoundError: No module named 'site_nine'

**Cause:** The site_nine package is not installed.

**Solutions:**

1. **If working ON site-nine itself:**
   ```bash
   cd /path/to/site-nine
   uv sync  # or: pip install -e .
   ```

2. **If using site-nine in another project:**
   ```bash
   pip install site-nine
   # or
   uv add site-nine
   ```

3. **Verify installation:**
   ```bash
   s9 doctor
   ```

### Command not found: s9

**Cause:** CLI entry point not in PATH or virtual environment not activated.

**Solutions:**

1. **Activate virtual environment:**
   ```bash
   source .venv/bin/activate  # Linux/Mac
   .venv\Scripts\activate     # Windows
   ```

2. **Or use uv run:**
   ```bash
   uv run s9 --help
   ```

3. **Or reinstall:**
   ```bash
   pip install -e .
   ```
```

### Phase 5: Testing

**5.1 Test error detection:**
- [ ] Uninstall site_nine: `pip uninstall site-nine`
- [ ] Run `s9 --version`, verify helpful error message
- [ ] Verify error message shows correct fix command
- [ ] Install with `uv sync`, verify error goes away

**5.2 Test session-start graceful degradation:**
- [ ] Uninstall site_nine
- [ ] Run session-start skill
- [ ] Verify it shows warnings but continues
- [ ] Verify manual session file creation still works

**5.3 Test s9 doctor:**
- [ ] With site_nine installed: `s9 doctor` shows all checks pass
- [ ] With site_nine uninstalled: shows appropriate errors and fixes
- [ ] In site-nine repo: detects editable mode correctly
- [ ] In other project: shows appropriate guidance

**5.4 Test in different contexts:**
- [ ] Test in site-nine repository (editable mode)
- [ ] Test in external project (normal install)
- [ ] Test with no installation (shows errors)
- [ ] Test with virtual environment activated vs. not

## Files Changed

### Created
- `src/site_nine/cli/_check.py` - Installation check helper
- `src/site_nine/cli/doctor.py` - Diagnostic command
- `.opencode/docs/guides/TROUBLESHOOTING.md` - Troubleshooting guide
- `tests/cli/test_doctor.py` - Tests for doctor command

### Modified
- `src/site_nine/cli/__init__.py` - Add installation check to main entry point, register doctor command
- `.opencode/skills/session-start/SKILL.md` - Add error handling and fallback behavior for s9 commands
- `.opencode/README.md` - Add development setup section with troubleshooting
- `README.md` - Ensure development setup is clear
- `.opencode/docs/guides/AGENTS.md` - Reference troubleshooting guide
- `pyproject.toml` - Verify entry points are correct

## Testing Performed

[Document test commands, results, verification]

## Notes

**Design Decisions:**

1. **Check at CLI entry point** - Catch errors before any command runs
2. **Context-aware error messages** - Different fixes for site-nine dev vs. external usage
3. **Graceful degradation** - Session-start can continue without database if needed
4. **Doctor command for diagnostics** - Easy way to verify installation
5. **Don't auto-fix** - Show user what to run, but don't automatically install (safer)

**Error Message Principles:**

- Clear explanation of what's wrong
- Specific fix command to run
- Context-aware (different message for site-nine dev vs. external)
- Don't assume user knowledge level

**Related Issues:**

- This affects all skills that use `s9` commands
- May need similar error handling in other skills (session-end, handoff-workflow)
- Consider adding health checks to other commands

**Estimated Effort:** M (Medium)
- Multiple touch points (CLI, skill, docs)
- Requires testing in different contexts
- Error handling can be tricky
- Documentation is important for clarity
