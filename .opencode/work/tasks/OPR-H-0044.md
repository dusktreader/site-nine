# Task OPR-H-0044: Unified /new and /summon commands with role parameter

**Status:** TODO
**Priority:** HIGH
**Role:** Operator
**Category:** feature
**Agent:** 
**Claimed:** 
**Actual Time:** 
**Closed:** 
**Paused:** 

## Objective

Make both `/new` and `/summon` OpenCode slash commands accept an optional role as a positional argument, so that starting a new OpenCode session and summoning an agent session happen in a single unified command.

## Problem Statement

Currently, the workflow for starting a new agent session involves:

1. Starting a new OpenCode session with `/new`
2. Then running the `session-start` skill or `/summon` command
3. Then selecting a role from the menu

This is inefficient when you already know which role you want. Users want to be able to:

```
/new Operator
```

Or:

```
/summon Builder
```

And have both:
- A new OpenCode session created (if using `/new`)
- The session-start skill automatically invoked with the specified role
- Skip the role selection prompt since it's already specified

## Requirements

### Must Have

1. **Positional role parameter for `/new`:**
   - `/new` - No role specified, normal OpenCode session (no auto-summon)
   - `/new <Role>` - Create new session AND immediately start session-start skill with role
   - Role should be case-insensitive (e.g., `operator`, `Operator`, `OPERATOR` all work)

2. **Positional role parameter for `/summon`:**
   - `/summon` - No role specified, show role selection menu (current behavior)
   - `/summon <Role>` - Start session-start skill with specified role, skip role menu
   - Role should be case-insensitive

3. **Role validation:**
   - If invalid role provided, show error with list of valid roles
   - Valid roles: Administrator, Architect, Builder, Tester, Documentarian, Designer, Inspector, Operator
   - Use case-insensitive matching

4. **Backward compatibility:**
   - `/new` with no argument still works (normal OpenCode session)
   - `/summon` with no argument still works (shows role menu)

5. **Integration with session-start skill:**
   - When role is provided, automatically invoke session-start skill
   - Pass role to skill so it can skip the role selection step
   - Still show project dashboard before role selection (if possible)
   - Still prompt for daemon name selection
   - All other session-start steps remain the same

### Should Have

- Tab completion for role names in OpenCode TUI
- Help text showing available roles when command is run without args
- Alias support (e.g., `admin` â†’ `Administrator`, `doc` â†’ `Documentarian`)

### Nice to Have

- `/new <Role> <daemon-name>` - Specify both role and daemon name in one command
- Recent role/name combinations shown as suggestions
- Role presets with preferred names

## Implementation Steps

### Phase 1: Understand OpenCode Command Extension

**1.1 Research OpenCode slash command system:**
- Read OpenCode documentation on custom slash commands
- Check `.opencode/commands/` directory for existing command examples
- Understand how to:
  - Accept positional parameters in slash commands
  - Modify behavior of built-in commands like `/new`
  - Invoke skills programmatically with parameters
  - Handle parameter validation

**1.2 Check if `/new` can be extended or needs wrapper:**
- Determine if `/new` is a built-in that can be modified
- If not, create `/start` as an alternative that wraps `/new` + session-start

**1.3 Examine current `/summon` implementation:**
- Check if `/summon` already exists as custom command
- If so, read current implementation
- If not, this is the opportunity to create it properly

### Phase 2: Implement Role Parameter Handling

**2.1 Create role validation utility:**
```typescript
// .opencode/commands/utils/roles.ts (or similar)
const VALID_ROLES = [
  'Administrator',
  'Architect', 
  'Builder',
  'Tester',
  'Documentarian',
  'Designer',
  'Inspector',
  'Operator'
] as const;

const ROLE_ALIASES = {
  'admin': 'Administrator',
  'doc': 'Documentarian',
  'docs': 'Documentarian',
  'build': 'Builder',
  'test': 'Tester',
  'qa': 'Tester',
  'review': 'Inspector',
  'ops': 'Operator'
};

export function validateRole(input: string): string | null {
  // Case-insensitive match
  const normalized = input.trim();
  
  // Check exact match (case-insensitive)
  const exactMatch = VALID_ROLES.find(
    role => role.toLowerCase() === normalized.toLowerCase()
  );
  if (exactMatch) return exactMatch;
  
  // Check aliases
  const alias = ROLE_ALIASES[normalized.toLowerCase()];
  if (alias) return alias;
  
  return null;
}

export function showRoleError(invalidRole: string): string {
  return `Invalid role: "${invalidRole}"

Valid roles:
  ${VALID_ROLES.join(', ')}

Aliases:
  ${Object.entries(ROLE_ALIASES).map(([alias, role]) => `${alias} â†’ ${role}`).join('\n  ')}
`;
}
```

### Phase 3: Implement Enhanced /summon Command

**3.1 Create or update `/summon` command:**
```typescript
// .opencode/commands/summon.ts (or similar)
import { validateRole, showRoleError } from './utils/roles';

export async function summon(args: string[]): Promise<void> {
  const roleArg = args[0]?.trim();
  
  if (!roleArg) {
    // No role specified - invoke skill normally (shows role menu)
    await invokeSkill('session-start');
    return;
  }
  
  // Validate role
  const role = validateRole(roleArg);
  if (!role) {
    console.error(showRoleError(roleArg));
    return;
  }
  
  // Invoke session-start skill with role pre-selected
  await invokeSkill('session-start', { role });
}
```

### Phase 4: Implement Enhanced /new Command

**4.1 Determine if /new can be hooked:**

**Option A: If /new supports extensions/hooks:**
```typescript
// .opencode/commands/new-hook.ts
export async function onNewSession(args: string[]): Promise<void> {
  const roleArg = args[0]?.trim();
  
  if (!roleArg) {
    // Normal /new behavior
    return;
  }
  
  const role = validateRole(roleArg);
  if (!role) {
    console.error(showRoleError(roleArg));
    return;
  }
  
  // After new session is created, auto-invoke session-start
  await invokeSkill('session-start', { role });
}
```

**Option B: If /new cannot be hooked, create /start wrapper:**
```typescript
// .opencode/commands/start.ts
export async function start(args: string[]): Promise<void> {
  const roleArg = args[0]?.trim();
  
  // First, create new OpenCode session
  await runCommand('/new');
  
  if (!roleArg) {
    // No role specified - just new session
    return;
  }
  
  const role = validateRole(roleArg);
  if (!role) {
    console.error(showRoleError(roleArg));
    return;
  }
  
  // Then auto-summon with role
  await invokeSkill('session-start', { role });
}
```

### Phase 5: Update session-start Skill

**5.1 Accept role as parameter in session-start skill:**

Modify `.opencode/skills/session-start/SKILL.md`:

```markdown
## Parameters

The session-start skill accepts an optional `role` parameter:

- If `role` is provided: Skip role selection step, use provided role
- If `role` is not provided: Show role selection menu (current behavior)

## Step 2: Role Selection (Conditional)

**If role parameter was NOT provided:**

[Current role selection logic]

**If role parameter WAS provided:**

Skip role selection menu. Validate that role is recognized:

```bash
# The role is already validated before skill invocation
# Just confirm to user:
echo "Role: ${role}"
```

Then proceed directly to Step 3: Daemon Name Selection.
```

**5.2 Update skill invocation to handle role parameter:**

The OpenCode skill system needs to be able to pass `{ role: "Operator" }` to the skill and have it accessible within the skill execution context.

Research how to:
- Accept parameters in skills
- Access those parameters within skill markdown/scripts
- Set environment variables or context for skill execution

### Phase 6: Register Commands in OpenCode

**6.1 Update `.opencode/opencode.json`:**
```json
{
  "commands": [
    {
      "name": "summon",
      "description": "Start a new agent session with optional role",
      "script": ".opencode/commands/summon.ts",
      "usage": "/summon [Role]",
      "examples": [
        "/summon",
        "/summon Operator", 
        "/summon builder"
      ]
    },
    {
      "name": "start",
      "description": "Create new OpenCode session and optionally summon agent",
      "script": ".opencode/commands/start.ts", 
      "usage": "/start [Role]",
      "examples": [
        "/start",
        "/start Administrator",
        "/start ops"
      ]
    }
  ]
}
```

### Phase 7: Testing

**7.1 Test /summon with role:**
- [ ] `/summon` - Shows role menu (existing behavior)
- [ ] `/summon Operator` - Starts session-start with Operator role
- [ ] `/summon operator` - Case-insensitive, works
- [ ] `/summon ops` - Alias works
- [ ] `/summon InvalidRole` - Shows error with valid roles list

**7.2 Test /new with role (or /start):**
- [ ] `/new` - Creates normal OpenCode session
- [ ] `/new Builder` - Creates session AND starts session-start with Builder
- [ ] `/new builder` - Case-insensitive works
- [ ] `/new build` - Alias works
- [ ] `/new InvalidRole` - Shows error

**7.3 Test skill integration:**
- [ ] Role parameter correctly passed to session-start skill
- [ ] Dashboard still shown before role selection
- [ ] Role selection step is skipped when role provided
- [ ] Daemon name selection still happens
- [ ] Rest of session-start workflow unchanged

**7.4 Test edge cases:**
- [ ] Extra whitespace in role argument handled
- [ ] Multiple arguments (should probably use first, ignore rest?)
- [ ] Empty string as role argument (should show role menu)

## Files Changed

### Created
- `.opencode/commands/summon.ts` (or `.js`) - Summon command implementation
- `.opencode/commands/start.ts` (or wrapper for /new) - Start command implementation  
- `.opencode/commands/utils/roles.ts` - Role validation utilities
- `tests/commands/test_summon.ts` - Tests for summon command
- `tests/commands/test_start.ts` - Tests for start command

### Modified
- `.opencode/opencode.json` - Register new commands
- `.opencode/skills/session-start/SKILL.md` - Accept and handle role parameter
- `.opencode/docs/guides/COMMANDS.md` - Document new command usage (if exists)
- `.opencode/README.md` - Update quickstart to mention `/new <Role>` shortcut

### Potentially Modified (depends on OpenCode internals)
- May need to extend OpenCode's skill invocation system to support parameters
- May need hooks/config to extend `/new` behavior

## Testing Performed

[Document test commands, results, verification]

## Notes

**Implementation Questions (need research):**

1. **How does OpenCode's slash command system work?**
   - TypeScript? JavaScript? Python?
   - How to accept positional arguments?
   - How to invoke skills programmatically?

2. **Can we hook into /new or do we need separate /start command?**
   - Preference: Hook into /new if possible
   - Fallback: Create /start as separate command

3. **How to pass parameters to skills?**
   - Environment variables?
   - Skill invocation API?
   - Context object?

4. **Where is /summon currently defined?**
   - Is it already a custom command?
   - Or is it just the session-start skill being invoked manually?

**Design Decisions:**

1. **Case-insensitive role matching** - Better UX, users don't need to remember exact casing
2. **Aliases supported** - Common shortcuts (ops, admin, doc) for convenience
3. **Positional argument** - More natural than `--role Operator` flag syntax
4. **Backward compatible** - Commands without role still work as before
5. **Skip role selection** - When role provided, don't show menu (it's redundant)

**User Experience:**

Before:
```
/new
[OpenCode session starts]
/summon
[Sees role menu]
operator
[Selects name, session starts]
```

After:
```
/new Operator
[OpenCode session starts AND session-start skill runs with Operator role]
[Just selects name, session starts]
```

Much faster! ðŸš€

**Related Tasks:**

- May want similar shortcuts for other workflows
- Consider `/resume <session-id>` to quickly resume paused sessions
- Consider `/handoff <role>` to create handoff to specific role

**Estimated Effort:** M (Medium)
- Need to research OpenCode command extension system
- Implementation depends on OpenCode's architecture
- Relatively straightforward once API is understood
- Testing across different usage patterns
