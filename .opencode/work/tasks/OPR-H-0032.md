# Task OPR-H-0032: Unify agent and session concepts into single session entity

**Status:** COMPLETE
**Priority:** HIGH
**Role:** Operator
**Category:** refactor
**Mission:** 
**Claimed:** 2026-02-04 00:55:44
**Actual Time:** 
**Closed:** 2026-02-04 05:28:09
**Paused:** 
## Objective

Refactor the entity model to use clear, unambiguous terminology and proper relationships:
- **Personas** (was `daemon_names`): Named identities with roles and mythological backgrounds
- **Missions** (was `agents`): Work assignments using personas, with auto-generated codenames
- **Agents**: External concept (OpenCode/Cursor AI instances) - not modeled in site-nine

**Key changes:**
1. Remove mission `status` field (use `end_time IS NULL` for active state)
2. Reverse task→mission relationship (`task.current_mission_id` instead of backward `agent_id`)
3. Decouple mission lifecycle from OpenCode session lifecycle
4. Auto-generate mission codenames deterministically using prime-length word lists (31×37 = 1,147 combinations)
5. Retroactively assign codenames to all 38 existing missions
6. Update 57 session markdown files with new terminology and codenames
7. Close 11 abandoned "in-progress" missions gracefully

**See ADR-006 for complete architectural design and implementation plan.**

## Status Update: Design Phase Complete (2026-02-03)

### ✅ ADR-006 Completed and Approved

**Architecture Decision Record created:** `.opencode/docs/adrs/ADR-006-entity-model-clarity.md`

**Key design decisions finalized:**

1. **Mission Codenames (Deterministic Prime Algorithm)**
   - 31 adjectives × 37 nouns = 1,147 unique combinations
   - Deterministic generation: `codename = f"{ADJECTIVES[mission_id % 31]}-{NOUNS[mission_id % 37]}"`
   - Examples: `silent-phoenix`, `crimson-falcon`, `void-matrix`
   - **No user-specified codenames** - always auto-generated
   - Tech-noir themed word lists (cyberpunk, cosmic, tactical)

2. **OpenCode Session Naming**
   - Session title format: `<Persona> - <Role> - <codename>`
   - Example: "Hemera - Operator - swift-thunder"
   - Persona capitalized in display (stored lowercase in frontmatter)
   - Command: `s9 mission rename-tui <persona> <Role> <codename>`

3. **Retroactive Migration Scope**
   - **38 existing missions** get codenames based on mission_id
   - **57 session markdown files** updated:
     - Frontmatter: `name` → `persona`, add `codename` and `mission_id`, remove `status`
     - Files renamed to include codename
     - Content terminology updated: "Agent" → "Persona", "session" → "mission"
   - **11 abandoned "in-progress" missions** closed with file `mtime`
   - **Directory rename:** `.opencode/work/sessions/` → `.opencode/work/missions/`

4. **Breaking Change (No Backward Compatibility)**
   - One-way migration, no rollback strategy
   - Clean break in terminology
   - Backup for disaster recovery only

### Implementation Ready

**Next step:** Create migration script and begin Phase 2 (Database and File Migration)

**Estimated phases:**
- Phase 1: ADR and design ✅ **COMPLETE**
- Phase 2: Database and file migration
- Phase 3: Code refactoring  
- Phase 4: CLI updates
- Phase 5: Skill and template updates
- Phase 6: Documentation and testing

---

## Problem Statement

**See ADR-006 for full context. Summary:**

**Terminology Confusion:**
- "Agent" is overloaded (persona? work period? OpenCode instance?)
- "Session" is overloaded (OpenCode chat? site-nine work record?)
- Creates confusion in code, docs, and user communication

**Abandoned Missions:**
- Current database has 12 "in-progress" agents from 1-2 days ago
- Only 1 task is actually UNDERWAY
- Problem: OpenCode closes but agent status doesn't update

**Difficult Handoffs:**
- Task has backward link (`agent_id`) making "who's working on this?" unclear
- Handoff requires multiple updates
- No single source of truth for current assignment

**Lifecycle Coupling (Wrong Assumption):**
- Current model assumes agent session lifecycle = OpenCode session lifecycle
- Reality: Missions should persist across OpenCode restarts
- Users don't run `/dismiss`, missions stay "in-progress" forever
   - Agent = database record in `agents` table
   - Session = markdown file in `.opencode/work/sessions/`
   - Both created/updated together, creating unnecessary complexity

2. **Dual Status Fields:** Both tasks and agents have `status` fields that can get out of sync
   - Agent status: `in-progress`, `completed`, `failed`, `aborted`
   - Task status: `TODO`, `UNDERWAY`, `COMPLETE`, `ABORTED`
   - Can have mismatches like: agent=`completed` but task=`UNDERWAY` (found in OPR-H-0005)

3. **Wrong Relationship Direction:** Tasks have `agent_id` and `agent_name` fields (currently unused)
   - Allows multiple agents per task? Unclear ownership
   - Makes handoffs complicated (would need to update task record)

4. **Conceptual Confusion:** "Agent" is overloaded
   - In reality: Agent = external actor (human or AI) using site-nine
   - In code: Agent = a session record
   - These are different concepts being conflated

**Desired State:**

- **Session** = One work period in site-nine (the only entity)
  - Stored in both database and markdown (same entity, two formats)
  - Has a daemon name and role
  - Optionally references a task it's working on

- **Agent** = External actor (not modeled in site-nine at all)
  - Just referenced in session metadata as "who did this work"

- **Task status** = Single source of truth (no agent status)

- **Session → Task reference:** Session has `current_task_id` (one session = one task max)
  - Handoffs just swap which session is assigned
  - Task never needs to know which session is working on it

## Implementation Steps

### ✅ Phase 0: Investigation and Architecture Analysis (COMPLETED - 2026-02-03 by Hemera)

**Current State Analysis:**

**Database Schema:**
- ✅ Examined `agents` table schema - has `status` field with 5 values (in-progress, paused, completed, failed, aborted)
- ✅ Examined `tasks` table schema - has `status` field with 7 values (TODO, UNDERWAY, BLOCKED, PAUSED, REVIEW, COMPLETE, ABORTED)
- ✅ Found `tasks.agent_name` and `tasks.agent_id` columns - currently 27 tasks have agent references
- ✅ Found existing `tasks.blocks_on_review_id` column (from OPR-H-0043 implementation)

**Current Data State:**
- 37 total agent sessions in database
- 25 sessions with status='completed'
- 12 sessions with status='in-progress' (some likely abandoned/stale)
- 27 tasks with agent_name or agent_id set
- ✅ NO MISMATCHES FOUND: No tasks have UNDERWAY status with non-in-progress agents

**Code Architecture:**
- Python module at `src/site_nine/agents/` with:
  - `sessions.py` - AgentSessionManager class (293 lines)
  - `roles.py` - Role definitions
  - Empty `__init__.py`
- CLI commands in `src/site_nine/cli/agent.py` (695 lines)
- 9 Python files import or reference agents:
  - check.py, reset.py, edit.py, dashboard.py, agent.py, init.py, name.py, doctor.py, sessions.py
- Only 2 explicit imports from `site_nine.agents` module

**Session File Format:**
- Markdown files in `.opencode/work/sessions/`
- YAML frontmatter with: date, start_time, end_time, role, name, task_summary, status
- Status field in frontmatter mirrors database status
- Session naming: `YYYY-MM-DD.HH:MM:SS.role.name.task-summary.md`

**Key Finding: Status Field Usage in Code**

The `status` field is ACTIVELY USED in multiple places:
1. `AgentSessionManager.list_sessions()` - filters by `status = 'in-progress'` for active_only
2. `AgentSessionManager.pause_session()` - sets status to 'paused'
3. `AgentSessionManager.resume_session()` - sets status to 'in-progress'
4. `AgentSessionManager.end_session()` - accepts status parameter (completed/failed/aborted)
5. `AgentSessionManager._update_session_file_frontmatter()` - updates status in markdown file
6. CLI commands rely on status to filter and display sessions

**Critical Insight: Status Cannot Be Removed**

Original task proposed removing `status` field from sessions, but investigation shows:
- ❌ Sessions NEED status independent of tasks (paused, completed, failed, aborted states)
- ❌ Not all sessions work on tasks (some are exploratory, some are multi-task)
- ❌ Session lifecycle is distinct from task lifecycle
- ✅ Session status represents "work period state" (active, paused, done)
- ✅ Task status represents "work item state" (TODO, UNDERWAY, COMPLETE)

**Revised Understanding:**

The "dual status problem" mentioned in the original task is NOT actually a problem:
1. Checked for status mismatches: NONE FOUND in current database
2. Sessions and tasks have different lifecycles - they SHOULD have separate statuses
3. Example valid states:
   - Session=in-progress, Task=UNDERWAY (actively working)
   - Session=completed, Task=UNDERWAY (handed off to another session)
   - Session=paused, Task=UNDERWAY (took a break)
   - Session=completed, no task (exploratory session)

**Recommendation: Scope Reduction**

Instead of the full refactor proposed, consider a smaller, safer change:
1. ✅ Keep `agents` table name (or rename to `sessions` only)
2. ✅ Keep session `status` field (it's necessary and actively used)
3. ✅ Add `current_task_id` to track session→task relationship
4. ✅ Keep `tasks.agent_name` for historical tracking (who worked on this)
5. ❌ Do NOT remove `tasks.agent_id` foreign key (useful for queries)

This achieves the main goal (clearer session→task relationship) without breaking working code.

---

### Phase 1: Database Schema Changes

**1.1 Rename `agents` table to `sessions`:**
```sql
ALTER TABLE agents RENAME TO sessions;
```

**1.2 Add `current_task_id` column:**
```sql
ALTER TABLE sessions ADD COLUMN current_task_id TEXT;
ALTER TABLE sessions ADD CONSTRAINT fk_sessions_current_task 
    FOREIGN KEY (current_task_id) REFERENCES tasks(id) ON DELETE SET NULL;
CREATE INDEX idx_sessions_current_task ON sessions(current_task_id);
```

**1.3 Remove `status` column from sessions:**
```sql
-- First, migrate any logic that depends on status
-- Then: ALTER TABLE sessions DROP COLUMN status;
-- (SQLite doesn't support DROP COLUMN, may need to recreate table)
```

**1.4 Remove agent fields from tasks:**
```sql
-- Remove: agent_id, agent_name
-- (SQLite doesn't support DROP COLUMN, may need to recreate table)
```

**1.5 Update all indices and triggers to reference `sessions` instead of `agents`**

---

### Phase 2: Data Migration

**2.1 Analyze current data:**
```bash
# Count agents by status
sqlite3 .opencode/data/project.db "SELECT status, COUNT(*) FROM agents GROUP BY status"

# Find tasks with agent_name set
sqlite3 .opencode/data/project.db "SELECT id, agent_name FROM tasks WHERE agent_name IS NOT NULL"

# Check for tasks where agent status doesn't match task status
sqlite3 .opencode/data/project.db "
SELECT t.id, t.status as task_status, t.agent_name, a.status as agent_status
FROM tasks t 
LEFT JOIN agents a ON t.agent_name = a.name
WHERE t.status = 'UNDERWAY' AND a.status != 'in-progress'
"
```

**2.2 Migrate existing agent records:**
- All existing agents become sessions (table rename handles this)
- Current `status` values:
  - `in-progress` → Check if they have an active task
  - `completed` → No action needed, these are done sessions
  - `failed`/`aborted` → No action needed, these are done sessions

**2.3 Populate `current_task_id` for active sessions:**
```sql
-- For sessions that are in-progress and have tasks UNDERWAY:
-- Need to determine which session is working on which task
-- May require looking at session files or task files for context
-- Manual review recommended for the ~12 in-progress sessions
```

**2.4 Update session markdown files:**
- Remove `status:` from frontmatter (if present)
- Keep all other fields
- Session state is implicit: has `end_time` = done, no `end_time` = active

**2.5 Update task markdown files:**
- Remove `**Agent:**` field from headers
- Keep historical references in work log ("Worked on by Cronos...")
- Agent info moves to session files only

---

### Phase 3: Code Changes

**3.1 Rename module: `src/site_nine/agents/` → `src/site_nine/sessions/`**
```bash
git mv src/site_nine/agents src/site_nine/sessions
```

**3.2 Update imports throughout codebase:**
```python
# FROM:
from site_nine.agents.sessions import SessionManager
# TO:
from site_nine.sessions.manager import SessionManager
```

**3.3 Update CLI commands:**
- `src/site_nine/cli/agent.py` → keep filename but update references
- Consider: Keep `s9 mission` commands as aliases? Or rename to `s9 session`?
  - `s9 mission start` → `s9 session start`
  - `s9 mission pause` → `s9 session pause`
  - etc.

**3.4 Update database access layer:**
- All queries referencing `agents` → `sessions`
- Remove `status` field from session queries
- Add `current_task_id` to session creation/updates

**3.5 Update task claim/complete logic:**
```python
# When claiming task:
def claim_task(session_id: int, task_id: str):
    # Update session
    db.execute("UPDATE sessions SET current_task_id = ? WHERE id = ?", 
               (task_id, session_id))
    
    # Update task
    db.execute("UPDATE tasks SET status = 'UNDERWAY', claimed_at = ? WHERE id = ?",
               (datetime.now(), task_id))

# When completing task:
def complete_task(task_id: str):
    # Update task
    db.execute("UPDATE tasks SET status = 'COMPLETE', closed_at = ? WHERE id = ?",
               (datetime.now(), task_id))
    
    # Clear session assignment
    db.execute("UPDATE sessions SET current_task_id = NULL WHERE current_task_id = ?",
               (task_id,))
```

**3.6 Update handoff logic:**
```python
# Handoff is now trivial:
def handoff_task(from_session_id: int, to_session_id: int, task_id: str):
    # Clear old session
    db.execute("UPDATE sessions SET current_task_id = NULL WHERE id = ?",
               (from_session_id,))
    
    # Assign to new session
    db.execute("UPDATE sessions SET current_task_id = ? WHERE id = ?",
               (task_id, to_session_id))
    
    # Task doesn't change at all!
```

**3.7 Update session start/end workflows:**
- Remove status field logic
- Add current_task_id management
- Update markdown frontmatter templates

**3.8 Update queries/reports:**
- Dashboard: Show sessions with current_task_id
- Task list: Show which session (if any) is working on task
- Session list: Show what task (if any) session is working on

---

### Phase 4: Update Documentation & Templates

**4.1 Update template files:**
- `src/site_nine/templates/base/work/sessions/` templates
- Remove `status:` from frontmatter
- Update any agent references

**4.2 Update skill files:**
- `.opencode/skills/session-start/` - update to reference sessions
- `.opencode/skills/session-end/` - remove status handling
- `.opencode/skills/handoff-workflow/` - update handoff logic

**4.3 Update documentation:**
- `.opencode/docs/agents/` - update terminology (keep "agent" as role concept?)
- `.opencode/docs/guides/` - update to explain session model
- `.opencode/docs/procedures/` - update workflows

**4.4 Update CLI help text:**
- All references to "agent" as entity → "session"
- Keep "agent" when referring to role/persona

---

### Phase 5: Testing

**5.1 Test database migration:**
- [ ] Verify `sessions` table exists with correct schema
- [ ] Verify all existing agent records migrated
- [ ] Verify indices and FKs work correctly
- [ ] Verify old `agents` table removed

**5.2 Test session lifecycle:**
- [ ] Start new session: `s9 session start`
- [ ] Claim task: `s9 task claim OPR-M-0031`
- [ ] Verify session has `current_task_id` set
- [ ] Complete task: `s9 task complete OPR-M-0031`
- [ ] Verify session `current_task_id` cleared
- [ ] End session: `s9 session end`

**5.3 Test handoffs:**
- [ ] Start two sessions
- [ ] First session claims task
- [ ] Handoff to second session
- [ ] Verify first session `current_task_id` cleared
- [ ] Verify second session `current_task_id` set
- [ ] Verify task status unchanged

**5.4 Test queries:**
- [ ] Dashboard shows active sessions correctly
- [ ] Task list shows current session (if any)
- [ ] Session list shows current task (if any)
- [ ] Historical data preserved

**5.5 Test edge cases:**
- [ ] Session end with active task (should clear or warn?)
- [ ] Task abort with active session (should clear session assignment)
- [ ] Multiple sessions claiming same task (should error)

---

### Phase 6: Migration Script

**6.1 Create migration script: `scripts/migrate_agents_to_sessions.py`**
```python
"""
Migrate agents table to sessions table with new schema.

Usage:
    python scripts/migrate_agents_to_sessions.py --dry-run
    python scripts/migrate_agents_to_sessions.py --execute
"""
```

**Script should:**
1. Backup current database
2. Rename `agents` → `sessions`
3. Add `current_task_id` column
4. Remove `status` column (recreate table if needed)
5. Update tasks table (remove agent_id, agent_name)
6. Analyze active sessions and suggest current_task_id values
7. Update session markdown files
8. Update task markdown files
9. Verify data integrity
10. Report summary of changes

**6.2 Run migration on test database first**

**6.3 Document rollback procedure (in case of issues)**

## Files Changed

### Created
- `scripts/migrate_agents_to_sessions.py` - Database migration script with dry-run mode
- Database backup before migration

### Modified (Database)
- `.opencode/data/project.db` - Rename agents→sessions, schema changes
- Remove `agents` table
- Create `sessions` table with new schema
- Update `tasks` table (remove agent_id, agent_name)
- Update all indices and foreign keys

### Modified (Code - Python)
- `src/site_nine/agents/` → `src/site_nine/sessions/` (rename directory)
- `src/site_nine/sessions/manager.py` - Update session management logic
- `src/site_nine/cli/agent.py` - Update CLI commands (or rename file)
- `src/site_nine/cli/task.py` - Update task claim/complete logic
- `src/site_nine/cli/dashboard.py` - Update queries to use sessions
- All files importing from `agents` module
- All database queries referencing `agents` table
- All references to agent `status` field

### Modified (Templates)
- `src/site_nine/templates/base/work/sessions/*.jinja` - Remove status from frontmatter
- Task template - Remove agent field from header

### Modified (Documentation)
- `.opencode/skills/session-start/SKILL.md` - Update to reference sessions
- `.opencode/skills/session-end/SKILL.md` - Remove status handling
- `.opencode/skills/handoff-workflow/SKILL.md` - Update handoff logic
- `.opencode/docs/guides/*.md` - Update terminology and examples
- `.opencode/docs/procedures/*.md` - Update workflow descriptions

### Modified (Session Files - All)
- All files in `.opencode/work/sessions/*.md` - Remove status from frontmatter

### Modified (Task Files - All)  
- All files in `.opencode/work/tasks/*.md` - Remove Agent field from header

## Testing Performed

[Document test commands, results, verification]

## Notes

**Design Discussion:** Nyx (Operator) session on 2026-02-03

**Key Decisions:**

1. **Session owns task reference** (not the other way around)
   - Session has `current_task_id` field
   - Task doesn't know about sessions
   - Makes handoffs simple (just swap session assignments)

2. **Task status is single source of truth**
   - ❌ REVISED: Session status is ALSO needed (different lifecycle)
   - ✅ Keep both status fields - they serve different purposes
   - No sync issues if relationship is properly understood

3. **Agent is external, not modeled**
   - "Agent" means the human or AI actor
   - "Session" is the work period record in site-nine
   - Keep using "agent" in docs/skills for role/persona concept

4. **One session = one task maximum**
   - ⚠️ QUESTION: Is this actually true in practice?
   - Many sessions don't have a specific task (exploratory work)
   - Some sessions may touch multiple tasks
   - Recommend: Allow `current_task_id` to be NULL (no active task)

**Migration Complexity - REVISED ASSESSMENT:**

**ORIGINAL:** HIGH - Full refactor touching everything
**REVISED:** MEDIUM - Incremental enhancement, not full rewrite

If we take the **reduced scope approach**:
- Add `current_task_id` to agents table (simple column addition)
- Optionally rename `agents` → `sessions` (table rename, moderate impact)
- Keep all existing status logic (no breaking changes)
- Update task claim/complete to set/clear `current_task_id`
- No need to touch all session/task files (frontmatter stays the same)

**Breaking Changes - REVISED:**

**ORIGINAL:** Major breaking changes to CLI, database, files
**REVISED:** Minimal breaking changes
- If we rename table: Update SQL queries (`agents` → `sessions`)
- If we keep table name: NO breaking changes, just enhancements
- CLI commands can stay as `s9 mission` (it's a good name for the concept)
- Markdown files don't need to change

**Benefits - REVISED:**

**ORIGINAL:** Eliminates sync bugs, simpler model
**REVISED:** Better tracking, not necessarily simpler
- ✅ Clearer which session (if any) is working on a task
- ✅ Better handoff workflow with explicit session tracking
- ✅ Database can answer "what task is this session working on?"
- ⚠️ Doesn't eliminate "sync bugs" because statuses are independent (as they should be)
- ⚠️ Not necessarily simpler - adds a field rather than removing complexity
- More accurate conceptual model

**Estimated Effort - REVISED:** 3-5 hours (reduced scope)
- Phase 1 (Schema): 1 hour - Add `current_task_id` column, optionally rename table
- Phase 2 (Code): 1-2 hours - Update task claim/complete logic
- Phase 3 (CLI): 0.5-1 hour - Add commands to show task→session relationships
- Phase 4 (Testing): 1-2 hours - Verify new relationships work correctly

**Risks - REVISED:**
- **LOW RISK** if we keep `agents` table name and just add column
- **MEDIUM RISK** if we rename `agents` → `sessions` (need to update all queries)
- Data integrity: Foreign key ensures `current_task_id` references valid task
- Backward compat: Old code will ignore new column, won't break

**Mitigation:**
- Database backup before any changes
- Test on copy of database first
- If renaming table: Use migration script with dry-run mode
- Phased rollout: Schema first, then gradually update code to use new field

---

## ⚠️ HEMERA'S REVISED RECOMMENDATIONS (2026-02-03 - After Director Feedback)

### Director's Key Insights

**I initially misunderstood the problem. Director clarified:**

1. **"An agent isn't actually 'in progress' if that agent isn't working in an OpenCode session"**
   - ✅ TRUE: Agent session = OpenCode chat session
   - ✅ When OpenCode closes, agent is done (not "paused" or "in-progress")
   - ✅ Current DB has 12 "in-progress" agents but most are abandoned OpenCode sessions

2. **"The task can remain in progress"**
   - ✅ Task status is independent of agent sessions
   - ✅ Task UNDERWAY = "work needed", not "agent is actively typing"
   - ✅ Tasks can wait between agent sessions

3. **"It needs to be very easy to hand the task off to another agent"**
   - ✅ Current model: Task has `agent_name` and `agent_id` (backward link)
   - ❌ Problem: Hard to find "who's working on this task?"
   - ✅ Better: Task has `current_session_id` (forward link)

4. **"The sync issue absolutely was happening, we just cleaned it up"**
   - ✅ My investigation found clean state because you already fixed it
   - ✅ But 12 abandoned "in-progress" agents proves the problem exists
   - ✅ Root cause: Agent `status` field doesn't match reality (OpenCode closed but agent still "in-progress")

### The Real Problem (Now Clear)

**Agent sessions get abandoned:**
```
User workflow:
1. Starts OpenCode chat, runs /summon operator
2. Agent works on task, makes progress  
3. User closes OpenCode window (doesn't run /dismiss)
4. Agent session still marked "in-progress" in DB
5. Task is orphaned (no one actually working on it)
6. Next agent needs to "claim" the task but hard to see current state
```

**Evidence from your DB:**
- 12 agents with `status='in-progress'`
- Most from 2026-02-02 (1-2 days old)
- Only 1 task with `status='UNDERWAY'`
- Abandoned agents clog up the system

### Why Original Refactor is Correct

**Remove agent `status` field:**
- Agent session state = `end_time IS NULL` (active) or `NOT NULL` (done)
- Simpler, accurate: no "paused" or "failed" states to manage
- When OpenCode closes, just set `end_time` → done
- No abandoned "in-progress" agents

**Reverse the relationship:**
- OLD: Task → Agent (task.agent_id points to agent)
- NEW: Task → Session (task.current_session_id points to current session)
- Handoff = just update task.current_session_id
- Easy to query: "Which tasks are being worked on?" → `WHERE current_session_id IS NOT NULL`
- Easy to query: "What is this agent working on?" → `WHERE current_session_id = 38`

**Rename agents → sessions:**
- Clearer conceptually: these are work sessions, not persistent agents
- Agent = persona/role (external concept)
- Session = one OpenCode chat period (database entity)

### Revised Design (Full Refactor - Simplified)

**New Schema:**

```sql
-- Rename agents → sessions
CREATE TABLE sessions (
    id INTEGER PRIMARY KEY,
    name TEXT NOT NULL,           -- e.g., "terminus"
    base_name TEXT NOT NULL,      -- e.g., "terminus" (before suffix)
    suffix TEXT,                  -- e.g., "2" if "terminus-2"
    role TEXT NOT NULL,           -- Operator, Builder, etc.
    session_file TEXT NOT NULL,   -- Path to markdown file
    session_date TEXT NOT NULL,   -- YYYY-MM-DD
    start_time TEXT NOT NULL,     -- HH:MM:SS
    end_time TEXT,                -- HH:MM:SS or NULL (still active)
    task_summary TEXT,            -- Brief description
    created_at TEXT NOT NULL,
    updated_at TEXT NOT NULL,
    -- NO STATUS FIELD
    FOREIGN KEY (base_name) REFERENCES daemon_names(name)
);

-- Update tasks table
CREATE TABLE tasks (
    id TEXT PRIMARY KEY,
    title TEXT NOT NULL,
    status TEXT NOT NULL,         -- TODO, UNDERWAY, COMPLETE, etc.
    priority TEXT NOT NULL,
    role TEXT NOT NULL,
    category TEXT,
    current_session_id INTEGER,   -- NEW: Who (if anyone) is working on this
    claimed_at TEXT,
    closed_at TEXT,
    -- REMOVE: agent_name, agent_id (no backward link)
    -- Keep historical record in markdown files
    FOREIGN KEY (current_session_id) REFERENCES sessions(id) ON DELETE SET NULL
);
```

**Session Lifecycle:**

```python
# Start session (OpenCode /summon)
session_id = db.execute(
    "INSERT INTO sessions (name, role, ..., start_time, end_time) VALUES (?, ?, ..., ?, NULL)",
    (name, role, ..., time.now(), None)
)

# Claim task
db.execute("UPDATE tasks SET current_session_id = ?, claimed_at = ? WHERE id = ?",
           (session_id, time.now(), task_id))

# Work on task...

# Complete task
db.execute("UPDATE tasks SET status = 'COMPLETE', current_session_id = NULL WHERE id = ?", 
           (task_id,))

# End session (OpenCode /dismiss or window closes)
db.execute("UPDATE sessions SET end_time = ? WHERE id = ?",
           (time.now(), session_id))

# Also clear any tasks still assigned to this session
db.execute("UPDATE tasks SET current_session_id = NULL WHERE current_session_id = ?",
           (session_id,))
```

**Handoff Workflow:**

```python
# Old agent ends session (or abandoned - we detect via OpenCode)
db.execute("UPDATE sessions SET end_time = ? WHERE id = ?", (time.now(), old_session_id))

# Task remains UNDERWAY, just clear current assignment
db.execute("UPDATE tasks SET current_session_id = NULL WHERE current_session_id = ?", 
           (old_session_id,))

# New agent claims task
db.execute("UPDATE tasks SET current_session_id = ? WHERE id = ?",
           (new_session_id, task_id))
```

**Benefits:**
1. ✅ No abandoned "in-progress" sessions (just check `end_time IS NULL`)
2. ✅ Easy handoffs (update `current_session_id`)
3. ✅ Clear who's working on what (`task.current_session_id`)
4. ✅ Simpler mental model (no status field to sync)
5. ✅ Accurate state (session active = OpenCode open)

### Implementation Plan - Revised

**Phase 1: Database Migration (2-3 hours)**
1. Backup database
2. Rename `agents` → `sessions` table
3. Remove `status` column from sessions (recreate table in SQLite)
4. Add `current_session_id` to tasks
5. Remove `agent_id`, `agent_name` from tasks (recreate table)
6. Migrate existing data:
   - Set `end_time` for all sessions with `status IN ('completed', 'failed', 'aborted')`
   - Clear `current_session_id` for all tasks (start fresh)
7. Update indices and foreign keys

**Phase 2: Code Changes (3-4 hours)**
1. Update `AgentSessionManager` → `SessionManager`
   - Remove `status` parameter from all methods
   - Use `end_time` to determine if session is active
   - Update `end_session()` to just set `end_time` and clear task assignments
2. Update task claim/complete logic to use `current_session_id`
3. Update all SQL queries: `agents` → `sessions`
4. Move `src/site_nine/agents/` → `src/site_nine/sessions/`
5. Update imports throughout codebase

**Phase 3: CLI Updates (1-2 hours)**
1. Update `s9 mission` commands (or rename to `s9 session`)
   - Remove status-based filtering (use `end_time IS NULL` instead)
   - Show `current_session_id` in task displays
2. Add handoff helpers:
   - `s9 task handoff <task-id> <new-session-id>` - Easy handoff command
   - `s9 task release <task-id>` - Clear current session assignment
3. Update dashboard to show active sessions and their tasks

**Phase 4: Session File Updates (1 hour)**
1. Update session markdown template:
   - Remove `status:` from frontmatter
   - Keep `end_time:` (NULL or time)
2. Update existing session files (optional - they'll still work)

**Phase 5: Documentation (1 hour)**
1. Update skills: session-start, session-end, handoff-workflow
2. Update agent docs to reference "sessions"
3. Update README and guides

**Phase 6: Testing (2-3 hours)**
1. Test session lifecycle (start, end)
2. Test task claim/complete
3. Test handoffs
4. Test abandoned session detection
5. Verify no data loss

**Total Effort: 10-13 hours**

### Migration Safety

**Risks:**
- Database schema changes are irreversible without backup
- All existing code references `agents` table
- Need to update ~9 Python files

**Mitigation:**
1. ✅ Create migration script with dry-run mode
2. ✅ Backup database before running
3. ✅ Test on copy of production DB first
4. ✅ Use transactions (rollback on error)
5. ✅ Keep old table as `agents_backup` until confident

**Rollback Plan:**
```sql
-- If migration fails:
DROP TABLE sessions;
ALTER TABLE agents_backup RENAME TO agents;
-- Restore tasks table from backup
```

### Next Steps

**I'm ready to proceed with the full refactor. Here's what I'll do:**

1. ✅ Create database migration script (`scripts/migrate_agents_to_sessions.py`)
2. ✅ Test migration on copy of database
3. ✅ Execute migration (with backup)
4. ✅ Update Python code (sessions module, CLI)
5. ✅ Update documentation
6. ✅ Test thoroughly

**Estimated completion: 10-13 hours of focused work**

Should I start with Phase 1 (database migration script)?

---

## Original Effort Estimate

**Estimated Effort:** 8-12 hours  
**Actual Effort (if Option A):** 3-5 hours  
**Actual Effort (if Original Plan):** 15-20+ hours