# Task OPR-H-0032: Unify agent and session concepts into single session entity

**Status:** TODO
**Priority:** HIGH
**Role:** Operator
**Category:** refactor
**Agent:** 
**Claimed:** 
**Actual Time:** 
**Closed:** 
**Paused:** 
## Objective

Refactor to treat sessions as the primary entity. Remove agent/session duality, eliminate agent status field, use task status as single source of truth, and have sessions reference tasks via current_task_id

## Problem Statement

**Current Issues:**

1. **Dual Entities:** System maintains both "agents" and "sessions" as separate concepts, but they're 1:1 and must stay in sync
   - Agent = database record in `agents` table
   - Session = markdown file in `.opencode/work/sessions/`
   - Both created/updated together, creating unnecessary complexity

2. **Dual Status Fields:** Both tasks and agents have `status` fields that can get out of sync
   - Agent status: `in-progress`, `completed`, `failed`, `aborted`
   - Task status: `TODO`, `UNDERWAY`, `COMPLETE`, `ABORTED`
   - Can have mismatches like: agent=`completed` but task=`UNDERWAY` (found in OPR-H-0005)

3. **Wrong Relationship Direction:** Tasks have `agent_id` and `agent_name` fields (currently unused)
   - Allows multiple agents per task? Unclear ownership
   - Makes handoffs complicated (would need to update task record)

4. **Conceptual Confusion:** "Agent" is overloaded
   - In reality: Agent = external actor (human or AI) using site-nine
   - In code: Agent = a session record
   - These are different concepts being conflated

**Desired State:**

- **Session** = One work period in site-nine (the only entity)
  - Stored in both database and markdown (same entity, two formats)
  - Has a daemon name and role
  - Optionally references a task it's working on

- **Agent** = External actor (not modeled in site-nine at all)
  - Just referenced in session metadata as "who did this work"

- **Task status** = Single source of truth (no agent status)

- **Session → Task reference:** Session has `current_task_id` (one session = one task max)
  - Handoffs just swap which session is assigned
  - Task never needs to know which session is working on it

## Implementation Steps

### Phase 1: Database Schema Changes

**1.1 Rename `agents` table to `sessions`:**
```sql
ALTER TABLE agents RENAME TO sessions;
```

**1.2 Add `current_task_id` column:**
```sql
ALTER TABLE sessions ADD COLUMN current_task_id TEXT;
ALTER TABLE sessions ADD CONSTRAINT fk_sessions_current_task 
    FOREIGN KEY (current_task_id) REFERENCES tasks(id) ON DELETE SET NULL;
CREATE INDEX idx_sessions_current_task ON sessions(current_task_id);
```

**1.3 Remove `status` column from sessions:**
```sql
-- First, migrate any logic that depends on status
-- Then: ALTER TABLE sessions DROP COLUMN status;
-- (SQLite doesn't support DROP COLUMN, may need to recreate table)
```

**1.4 Remove agent fields from tasks:**
```sql
-- Remove: agent_id, agent_name
-- (SQLite doesn't support DROP COLUMN, may need to recreate table)
```

**1.5 Update all indices and triggers to reference `sessions` instead of `agents`**

---

### Phase 2: Data Migration

**2.1 Analyze current data:**
```bash
# Count agents by status
sqlite3 .opencode/data/project.db "SELECT status, COUNT(*) FROM agents GROUP BY status"

# Find tasks with agent_name set
sqlite3 .opencode/data/project.db "SELECT id, agent_name FROM tasks WHERE agent_name IS NOT NULL"

# Check for tasks where agent status doesn't match task status
sqlite3 .opencode/data/project.db "
SELECT t.id, t.status as task_status, t.agent_name, a.status as agent_status
FROM tasks t 
LEFT JOIN agents a ON t.agent_name = a.name
WHERE t.status = 'UNDERWAY' AND a.status != 'in-progress'
"
```

**2.2 Migrate existing agent records:**
- All existing agents become sessions (table rename handles this)
- Current `status` values:
  - `in-progress` → Check if they have an active task
  - `completed` → No action needed, these are done sessions
  - `failed`/`aborted` → No action needed, these are done sessions

**2.3 Populate `current_task_id` for active sessions:**
```sql
-- For sessions that are in-progress and have tasks UNDERWAY:
-- Need to determine which session is working on which task
-- May require looking at session files or task files for context
-- Manual review recommended for the ~12 in-progress sessions
```

**2.4 Update session markdown files:**
- Remove `status:` from frontmatter (if present)
- Keep all other fields
- Session state is implicit: has `end_time` = done, no `end_time` = active

**2.5 Update task markdown files:**
- Remove `**Agent:**` field from headers
- Keep historical references in work log ("Worked on by Cronos...")
- Agent info moves to session files only

---

### Phase 3: Code Changes

**3.1 Rename module: `src/site_nine/agents/` → `src/site_nine/sessions/`**
```bash
git mv src/site_nine/agents src/site_nine/sessions
```

**3.2 Update imports throughout codebase:**
```python
# FROM:
from site_nine.agents.sessions import SessionManager
# TO:
from site_nine.sessions.manager import SessionManager
```

**3.3 Update CLI commands:**
- `src/site_nine/cli/agent.py` → keep filename but update references
- Consider: Keep `s9 agent` commands as aliases? Or rename to `s9 session`?
  - `s9 agent start` → `s9 session start`
  - `s9 agent pause` → `s9 session pause`
  - etc.

**3.4 Update database access layer:**
- All queries referencing `agents` → `sessions`
- Remove `status` field from session queries
- Add `current_task_id` to session creation/updates

**3.5 Update task claim/complete logic:**
```python
# When claiming task:
def claim_task(session_id: int, task_id: str):
    # Update session
    db.execute("UPDATE sessions SET current_task_id = ? WHERE id = ?", 
               (task_id, session_id))
    
    # Update task
    db.execute("UPDATE tasks SET status = 'UNDERWAY', claimed_at = ? WHERE id = ?",
               (datetime.now(), task_id))

# When completing task:
def complete_task(task_id: str):
    # Update task
    db.execute("UPDATE tasks SET status = 'COMPLETE', closed_at = ? WHERE id = ?",
               (datetime.now(), task_id))
    
    # Clear session assignment
    db.execute("UPDATE sessions SET current_task_id = NULL WHERE current_task_id = ?",
               (task_id,))
```

**3.6 Update handoff logic:**
```python
# Handoff is now trivial:
def handoff_task(from_session_id: int, to_session_id: int, task_id: str):
    # Clear old session
    db.execute("UPDATE sessions SET current_task_id = NULL WHERE id = ?",
               (from_session_id,))
    
    # Assign to new session
    db.execute("UPDATE sessions SET current_task_id = ? WHERE id = ?",
               (task_id, to_session_id))
    
    # Task doesn't change at all!
```

**3.7 Update session start/end workflows:**
- Remove status field logic
- Add current_task_id management
- Update markdown frontmatter templates

**3.8 Update queries/reports:**
- Dashboard: Show sessions with current_task_id
- Task list: Show which session (if any) is working on task
- Session list: Show what task (if any) session is working on

---

### Phase 4: Update Documentation & Templates

**4.1 Update template files:**
- `src/site_nine/templates/base/work/sessions/` templates
- Remove `status:` from frontmatter
- Update any agent references

**4.2 Update skill files:**
- `.opencode/skills/session-start/` - update to reference sessions
- `.opencode/skills/session-end/` - remove status handling
- `.opencode/skills/handoff-workflow/` - update handoff logic

**4.3 Update documentation:**
- `.opencode/docs/agents/` - update terminology (keep "agent" as role concept?)
- `.opencode/docs/guides/` - update to explain session model
- `.opencode/docs/procedures/` - update workflows

**4.4 Update CLI help text:**
- All references to "agent" as entity → "session"
- Keep "agent" when referring to role/persona

---

### Phase 5: Testing

**5.1 Test database migration:**
- [ ] Verify `sessions` table exists with correct schema
- [ ] Verify all existing agent records migrated
- [ ] Verify indices and FKs work correctly
- [ ] Verify old `agents` table removed

**5.2 Test session lifecycle:**
- [ ] Start new session: `s9 session start`
- [ ] Claim task: `s9 task claim OPR-M-0031`
- [ ] Verify session has `current_task_id` set
- [ ] Complete task: `s9 task complete OPR-M-0031`
- [ ] Verify session `current_task_id` cleared
- [ ] End session: `s9 session end`

**5.3 Test handoffs:**
- [ ] Start two sessions
- [ ] First session claims task
- [ ] Handoff to second session
- [ ] Verify first session `current_task_id` cleared
- [ ] Verify second session `current_task_id` set
- [ ] Verify task status unchanged

**5.4 Test queries:**
- [ ] Dashboard shows active sessions correctly
- [ ] Task list shows current session (if any)
- [ ] Session list shows current task (if any)
- [ ] Historical data preserved

**5.5 Test edge cases:**
- [ ] Session end with active task (should clear or warn?)
- [ ] Task abort with active session (should clear session assignment)
- [ ] Multiple sessions claiming same task (should error)

---

### Phase 6: Migration Script

**6.1 Create migration script: `scripts/migrate_agents_to_sessions.py`**
```python
"""
Migrate agents table to sessions table with new schema.

Usage:
    python scripts/migrate_agents_to_sessions.py --dry-run
    python scripts/migrate_agents_to_sessions.py --execute
"""
```

**Script should:**
1. Backup current database
2. Rename `agents` → `sessions`
3. Add `current_task_id` column
4. Remove `status` column (recreate table if needed)
5. Update tasks table (remove agent_id, agent_name)
6. Analyze active sessions and suggest current_task_id values
7. Update session markdown files
8. Update task markdown files
9. Verify data integrity
10. Report summary of changes

**6.2 Run migration on test database first**

**6.3 Document rollback procedure (in case of issues)**

## Files Changed

### Created
- `scripts/migrate_agents_to_sessions.py` - Database migration script with dry-run mode
- Database backup before migration

### Modified (Database)
- `.opencode/data/project.db` - Rename agents→sessions, schema changes
- Remove `agents` table
- Create `sessions` table with new schema
- Update `tasks` table (remove agent_id, agent_name)
- Update all indices and foreign keys

### Modified (Code - Python)
- `src/site_nine/agents/` → `src/site_nine/sessions/` (rename directory)
- `src/site_nine/sessions/manager.py` - Update session management logic
- `src/site_nine/cli/agent.py` - Update CLI commands (or rename file)
- `src/site_nine/cli/task.py` - Update task claim/complete logic
- `src/site_nine/cli/dashboard.py` - Update queries to use sessions
- All files importing from `agents` module
- All database queries referencing `agents` table
- All references to agent `status` field

### Modified (Templates)
- `src/site_nine/templates/base/work/sessions/*.jinja` - Remove status from frontmatter
- Task template - Remove agent field from header

### Modified (Documentation)
- `.opencode/skills/session-start/SKILL.md` - Update to reference sessions
- `.opencode/skills/session-end/SKILL.md` - Remove status handling
- `.opencode/skills/handoff-workflow/SKILL.md` - Update handoff logic
- `.opencode/docs/guides/*.md` - Update terminology and examples
- `.opencode/docs/procedures/*.md` - Update workflow descriptions

### Modified (Session Files - All)
- All files in `.opencode/work/sessions/*.md` - Remove status from frontmatter

### Modified (Task Files - All)  
- All files in `.opencode/work/tasks/*.md` - Remove Agent field from header

## Testing Performed

[Document test commands, results, verification]

## Notes

**Design Discussion:** Nyx (Operator) session on 2026-02-03

**Key Decisions:**

1. **Session owns task reference** (not the other way around)
   - Session has `current_task_id` field
   - Task doesn't know about sessions
   - Makes handoffs simple (just swap session assignments)

2. **Task status is single source of truth**
   - Remove agent/session `status` field entirely
   - No sync issues possible
   - Session is "active" if it has `current_task_id` set

3. **Agent is external, not modeled**
   - "Agent" means the human or AI actor
   - "Session" is the work period record in site-nine
   - Keep using "agent" in docs/skills for role/persona concept

4. **One session = one task maximum**
   - Enforced by `current_task_id` being singular (not array)
   - If session needs to work on multiple tasks, claim/complete each in sequence

**Migration Complexity:**
- **HIGH** - This touches database, code, templates, docs, and ALL existing session/task files
- Recommend: Create comprehensive migration script with dry-run mode
- Recommend: Backup database before migration
- Recommend: Test thoroughly on copy of production data first

**Breaking Changes:**
- CLI commands may change: `s9 agent` → `s9 session` (or keep as alias)
- Database schema incompatible with old code
- Session/task markdown frontmatter format changes

**Benefits:**
- Eliminates entire class of sync bugs (agent status vs task status)
- Simpler mental model (one entity, not two)
- Cleaner handoff workflow
- More accurate conceptual model

**Estimated Effort:** 8-12 hours
- Phase 1 (Schema): 1-2 hours
- Phase 2 (Migration): 2-3 hours (careful work, data safety critical)
- Phase 3 (Code): 3-4 hours
- Phase 4 (Docs/Templates): 1-2 hours
- Phase 5 (Testing): 2-3 hours

**Risks:**
- Data loss if migration fails
- Breakage of existing workflows during transition
- Incomplete migration could leave system in inconsistent state

**Mitigation:**
- Comprehensive testing on copy first
- Database backup before migration
- Dry-run mode for migration script
- Rollback procedure documented
- Phased rollout (schema → data → code → docs)