# Task OPR-H-0043: Implement review tracking system for task approval workflow

**Status:** COMPLETE
**Priority:** HIGH
**Role:** Operator
**Category:** feature
**Mission:** 
**Claimed:** 2026-02-03 23:12:28
**Actual Time:** 
**Closed:** 2026-02-03 23:20:49
**Paused:** 
## Objective

Create a review tracking system in the database to track when tasks, designs, code, or other artifacts need Director approval before proceeding. Reviews should block dependent tasks and be displayed during Administrator session startup.

## Problem Statement

Currently, agents can complete tasks and dismiss themselves without Director approval. There's no way to:

1. Mark that a task/design/code change needs human review before proceeding
2. Track pending reviews in the database
3. Block dependent tasks until reviews are complete
4. Show pending reviews to the Director when starting a new session
5. Distinguish between different types of reviews (code, design, task completion, etc.)

This leads to:
- Agents marking tasks complete when they shouldn't be
- No workflow for design/architecture approval before implementation
- Tasks being worked on before their design dependencies are approved
- Director losing visibility into what needs their attention

## Requirements

### Must Have

1. **Database schema for reviews:**
   - Store review requests with type, status, and associated task/artifact
   - Link reviews to tasks they're associated with
   - Track who requested review and when
   - Track when review was completed and outcome

2. **Review types:**
   - Code/PR reviews - Code changes need approval before merging
   - Task completion reviews - Completed task needs Director sign-off
   - Design/architecture reviews - ADR or design needs approval before implementation
   - General artifact reviews - Any other type of review

3. **Review blocking:**
   - Tasks that depend on design reviews can't be claimed until review is approved
   - Clear indication in task list which tasks are blocked by pending reviews
   - Automatic status updates when blocking review is completed

4. **Administrator startup display:**
   - Show pending reviews immediately after role selection (only for Administrator)
   - Group by review type with clear formatting
   - Show associated task IDs and descriptions
   - Provide commands to approve/reject reviews

5. **CLI commands:**
   - `s9 review create <task-id> --type <type> --description "..."` - Request a review
   - `s9 review list [--status pending|approved|rejected]` - List reviews
   - `s9 review approve <review-id>` - Approve a review
   - `s9 review reject <review-id> --reason "..."` - Reject a review with reason
   - `s9 review show <review-id>` - Show review details

### Should Have

- Ability to add review comments/notes
- Email/notification when review is requested (future)
- Review history/audit trail
- Batch approve multiple reviews

### Nice to Have

- Different reviewers (not just Director)
- Review assignments
- Review templates by type
- Automated review requests (e.g., always review on task complete)

## Implementation Steps

### Phase 1: Database Schema

**1.1 Create reviews table:**
```sql
CREATE TABLE reviews (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    type TEXT NOT NULL CHECK(type IN ('code', 'task_completion', 'design', 'general')),
    status TEXT NOT NULL DEFAULT 'pending' CHECK(status IN ('pending', 'approved', 'rejected')),
    task_id TEXT,  -- Associated task (optional, not all reviews are task-related)
    title TEXT NOT NULL,
    description TEXT,
    requested_by TEXT,  -- Daemon name who requested review
    requested_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    reviewed_by TEXT,  -- Who completed the review
    reviewed_at TIMESTAMP,
    outcome_reason TEXT,  -- Why approved/rejected
    artifact_path TEXT,  -- Path to artifact being reviewed (PR, file, ADR, etc.)
    FOREIGN KEY (task_id) REFERENCES tasks(id) ON DELETE SET NULL
);

CREATE INDEX idx_reviews_status ON reviews(status);
CREATE INDEX idx_reviews_type ON reviews(type);
CREATE INDEX idx_reviews_task_id ON reviews(task_id);
```

**1.2 Add review dependency tracking to tasks:**
```sql
ALTER TABLE tasks ADD COLUMN blocks_on_review_id INTEGER;
ALTER TABLE tasks ADD CONSTRAINT fk_tasks_blocks_on_review
    FOREIGN KEY (blocks_on_review_id) REFERENCES reviews(id) ON DELETE SET NULL;
CREATE INDEX idx_tasks_blocks_on_review ON tasks(blocks_on_review_id);
```

### Phase 2: Core Review Management

**2.1 Create review manager module:**
- `src/site_nine/reviews/manager.py` - Core review CRUD operations
- `src/site_nine/reviews/models.py` - Review data models
- `src/site_nine/reviews/types.py` - Review type enum and constants

**2.2 Implement review lifecycle:**
```python
class ReviewManager:
    def create_review(
        self,
        type: ReviewType,
        title: str,
        description: str = None,
        task_id: str = None,
        requested_by: str = None,
        artifact_path: str = None
    ) -> int:
        """Create a new review request, returns review_id"""
        pass

    def approve_review(self, review_id: int, reviewed_by: str, reason: str = None):
        """Approve a review and unblock dependent tasks"""
        pass

    def reject_review(self, review_id: int, reviewed_by: str, reason: str):
        """Reject a review"""
        pass

    def list_reviews(self, status: str = None, type: str = None) -> list[Review]:
        """List reviews with optional filtering"""
        pass

    def get_pending_reviews(self) -> list[Review]:
        """Get all pending reviews (for startup display)"""
        pass

    def get_blocked_tasks(self) -> list[Task]:
        """Get tasks blocked by pending reviews"""
        pass
```

### Phase 3: CLI Commands

**3.1 Create `src/site_nine/cli/review.py`:**
```python
import typer
from rich.console import Console
from rich.table import Table

app = typer.Typer(help="Manage review requests")
console = Console()

@app.command()
def create(
    task_id: str = typer.Argument(None, help="Associated task ID"),
    type: str = typer.Option(..., "--type", "-t", help="Review type"),
    title: str = typer.Option(..., "--title", help="Review title"),
    description: str = typer.Option(None, "--description", "-d", help="Description"),
    artifact: str = typer.Option(None, "--artifact", "-a", help="Path to artifact")
):
    """Request a review"""
    pass

@app.command()
def list(
    status: str = typer.Option(None, "--status", "-s", help="Filter by status"),
    type: str = typer.Option(None, "--type", "-t", help="Filter by type")
):
    """List reviews"""
    pass

@app.command()
def approve(
    review_id: int = typer.Argument(..., help="Review ID"),
    reason: str = typer.Option(None, "--reason", "-r", help="Approval reason")
):
    """Approve a review"""
    pass

@app.command()
def reject(
    review_id: int = typer.Argument(..., help="Review ID"),
    reason: str = typer.Option(..., "--reason", "-r", help="Rejection reason")
):
    """Reject a review"""
    pass

@app.command()
def show(review_id: int = typer.Argument(..., help="Review ID")):
    """Show review details"""
    pass
```

**3.2 Register in main CLI:**
```python
# src/site_nine/cli/__init__.py
from site_nine.cli import review
app.add_typer(review.app, name="review")
```

### Phase 4: Task Blocking Logic

**4.1 Update task claim logic:**
```python
def claim_task(session_id: int, task_id: str):
    # Check if task is blocked by pending review
    task = get_task(task_id)
    if task.blocks_on_review_id:
        review = get_review(task.blocks_on_review_id)
        if review.status == 'pending':
            raise TaskBlockedError(
                f"Task {task_id} is blocked by pending review #{review.id} ({review.title})"
            )
    
    # Proceed with normal claim
    ...
```

**4.2 Update dashboard to show blocked tasks:**
- Add "Blocked" column or indicator
- Show which review is blocking the task
- Filter option to show/hide blocked tasks

### Phase 5: Session Startup Integration

**5.1 Update session-start skill:**
Add step after role selection (only for Administrator):
```markdown
## Step X: Show Pending Reviews (Administrator Only)

**If role is Administrator**, check for pending reviews:

```bash
uv run s9 review list --status pending
```

**If reviews exist:**

Present them in a formatted table:
```
ðŸ”” **Pending Reviews**

| ID | Type             | Task      | Title                              | Requested    |
|----|------------------|-----------|------------------------------------|--------------|
| 42 | design           | ARC-H-003 | API authentication design          | 2 hours ago  |
| 43 | task_completion  | ENG-M-012 | User profile implementation        | 1 day ago    |
| 44 | code             | ENG-H-008 | Security fix for auth middleware   | 30 mins ago  |

**Commands:**
- `s9 review show <id>` - View review details
- `s9 review approve <id>` - Approve review
- `s9 review reject <id> --reason "..."` - Reject review

**Blocked Tasks:** 3 tasks are waiting on review approvals
```

**If no reviews:**
- Skip this section silently
```

**5.2 Create review display template:**
- `src/site_nine/templates/reviews/pending_summary.jinja` - Format for startup display

### Phase 6: Testing

**6.1 Test review lifecycle:**
- [ ] Create design review for architecture task
- [ ] Verify task that depends on it can't be claimed
- [ ] Approve review
- [ ] Verify task can now be claimed
- [ ] Create task completion review
- [ ] Reject review with reason
- [ ] Verify reason is stored and displayed

**6.2 Test Administrator startup:**
- [ ] Start Administrator session with pending reviews
- [ ] Verify reviews are displayed after role selection
- [ ] Verify reviews show correct grouping and formatting
- [ ] Start non-Administrator session
- [ ] Verify reviews are NOT displayed

**6.3 Test blocking logic:**
- [ ] Try to claim blocked task, verify error message
- [ ] Complete blocking review
- [ ] Verify task is now claimable
- [ ] Verify dashboard shows blocked status correctly

**6.4 Test CLI commands:**
- [ ] `s9 review create` with all options
- [ ] `s9 review list` with different filters
- [ ] `s9 review show` displays full details
- [ ] `s9 review approve` updates status
- [ ] `s9 review reject` requires reason

## Files Changed

### Created
- `src/site_nine/reviews/__init__.py` - Reviews module
- `src/site_nine/reviews/manager.py` - Review management logic
- `src/site_nine/reviews/models.py` - Review data models
- `src/site_nine/reviews/types.py` - Review type enum
- `src/site_nine/cli/review.py` - Review CLI commands
- `src/site_nine/templates/reviews/pending_summary.jinja` - Review display template
- `tests/reviews/test_manager.py` - Review manager tests
- `tests/cli/test_review.py` - Review CLI tests
- Database migration script for reviews table

### Modified
- `src/site_nine/cli/__init__.py` - Register review commands
- `src/site_nine/tasks/manager.py` - Add task blocking logic to claim
- `src/site_nine/cli/task.py` - Show blocked status in task commands
- `src/site_nine/cli/dashboard.py` - Display blocked tasks indicator
- `.opencode/skills/session-start/SKILL.md` - Add pending reviews step for Administrator
- `.opencode/data/project.db` - Add reviews table and task foreign key
- `.opencode/docs/guides/WORKFLOWS.md` - Document review approval workflow

### Database Schema
- New `reviews` table
- New `tasks.blocks_on_review_id` foreign key column

## Testing Performed

[Document test commands, results, verification]

## Notes

**Design Decisions:**

1. **Review types are extensible** - Using TEXT with CHECK constraint allows adding new types without schema migration
2. **Optional task association** - Not all reviews are task-related (e.g., general code review)
3. **Single blocker per task** - Tasks can only be blocked by one review (keeps it simple)
4. **Administrator-only display** - Other roles don't see pending reviews to avoid distraction
5. **Soft blocking** - Blocked tasks still show in lists but can't be claimed

**Future Enhancements:**

- Multiple reviewers per review
- Review assignments (assign specific reviewers)
- Review templates by type
- Automated review creation (e.g., on task complete)
- Review notifications
- Review comments/discussion
- Review due dates/SLA tracking

**Related Tasks:**

- May need to update task templates to include review fields
- Consider adding review shortcuts (e.g., "complete task and request review" in one command)
- Handoff workflow may need review integration

**Estimated Effort:** L (Large)
- Significant feature with database schema, new module, CLI commands, integration points
- Requires testing across multiple workflows
- Documentation and skill updates needed
