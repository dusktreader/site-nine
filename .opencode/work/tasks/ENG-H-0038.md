# Task ENG-H-0038: Implement epic/task sync commands (DB as source of truth)

**Status:** COMPLETE
**Priority:** HIGH
**Role:** Engineer
**Category:** feature
**Mission:** 
**Claimed:** 2026-02-04 15:46:38
**Actual Time:** 
**Closed:** 2026-02-04 15:47:25
**Paused:** 
## Objective

Implement s9 epic sync and s9 task sync commands to regenerate markdown artifacts from database when out of sync

## Problem Statement

Markdown files can become out of sync with the database when:
- Direct database updates are made
- Migrations change data structure
- Files are accidentally deleted or modified incorrectly
- Agent operations update database but fail to update markdown

The system needed a way to regenerate markdown files from the database as the source of truth.

## Implementation Steps

### Discovery (2026-02-04)

1. Found that `s9 task sync` **already existed** in the codebase
   - Located in `src/site_nine/cli/task.py` lines 789-820
   - Supports syncing single task: `s9 task sync --task TASK-ID`
   - Supports syncing all tasks: `s9 task sync`
   - Uses `_sync_task_file()` helper function

2. Found that `s9 epic sync` was **implemented in ENG-H-0037**
   - Added to `src/site_nine/cli/epic.py` lines 387-423
   - Supports syncing single epic: `s9 epic sync --epic EPIC-ID`
   - Supports syncing all epics: `s9 epic sync`
   - Uses `_sync_epic_file()` helper function

### Verification (2026-02-04)

3. Tested both sync commands to ensure they work correctly:
   - Epic sync for specific epic: `s9 epic sync --epic EPC-M-0003` ✅
   - Task sync for specific task: `s9 task sync --task ENG-H-0038` ✅
   - Epic sync for all: `s9 epic sync` (synced 3 epics) ✅
   - Task sync for all: `s9 task sync` (synced 60 tasks) ✅

### Design Pattern

Both commands follow the same pattern:
- **Database as source of truth**: Always regenerate from database, never read from markdown
- **Header regeneration**: Metadata (status, priority, dates) always updated from DB
- **Body preservation**: Existing body content (Objective, Implementation Steps, etc.) is preserved
- **Safe file operations**: Use `validate_path_within_project()` to prevent directory traversal
- **Atomic updates**: Create parent directories if needed, write complete file in one operation

## Files Changed

### Previously Implemented
- `src/site_nine/cli/task.py` - Contains `sync` command (789-820) and `_sync_task_file()` helper (822-904)
- `src/site_nine/cli/epic.py` - Contains `sync` command (387-423) and `_sync_epic_file()` helper (430-540)

**No changes needed** - functionality was already complete.

## Testing Performed

All sync commands tested successfully:

```bash
# Test 1: Sync specific epic
s9 epic sync --epic EPC-M-0003
# Result: ✓ Synced epic EPC-M-0003

# Test 2: Sync specific task
s9 task sync --task ENG-H-0038
# Result: ✓ Synced task ENG-H-0038

# Test 3: Sync all epics
s9 epic sync
# Result: ✓ Synced 3 epic(s)

# Test 4: Sync all tasks
s9 task sync
# Result: ✓ Synced 60 task(s)
```

**Verification tests**:
- ✅ Markdown files regenerated with current database values
- ✅ Existing body content preserved (not overwritten)
- ✅ Missing files created automatically
- ✅ Parent directories created if needed
- ✅ Both single-item and bulk sync work correctly

## Notes

- **Task was already complete** when claimed - sync commands already existed
- `s9 task sync` was implemented before epic system was added
- `s9 epic sync` was implemented as part of ENG-H-0037 (epic markdown generation)
- Both follow the same architectural pattern for consistency
- Database is always the source of truth - markdown files are generated artifacts
- Sync commands are idempotent - safe to run multiple times
- Used when:
  - After database migrations
  - When markdown files are deleted or corrupted
  - After manual database updates
  - To ensure all files match database state