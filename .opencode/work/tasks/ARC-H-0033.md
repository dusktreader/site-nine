# Task ARC-H-0033: Design and implement epic database schema

**Status:** TODO
**Priority:** HIGH
**Role:** Architect
**Category:** architecture
**Agent:** 
**Claimed:** 
**Actual Time:** 
**Closed:** 
**Paused:** 


## Objective

Create database schema for epics table, add epic_id to tasks, create triggers for status updates, and design Epic data model

## Problem Statement

**Current State:**
Tasks exist as standalone entities with no way to group related work under a larger initiative.

**Need:**
Introduce "epics" (or over-tasks) that represent larger projects composed of multiple subtasks. Epics provide:
- Organizational structure for related tasks
- Progress tracking across multiple tasks
- Completion tracking (epic complete when all subtasks complete)
- Ability to abort entire initiatives (epic abort → all subtasks abort)

**Requirements:**
1. One task can belong to at most one epic (or no epic)
2. Tasks can exist without an epic (standalone)
3. Epics have priority indicated in ID: `EPC-H-0003` (HIGH priority)
4. Epics are not assigned to sessions/agents (organizational only)
5. Epics have markdown artifacts in `.opencode/work/epics/`
6. Epic progress measured by subtask completion
7. Epic status is derived from subtask states (auto-computed)
8. Aborting epic aborts ALL subtasks (cascade with confirmation)
9. Tasks can be moved between epics or made standalone
10. Database is source of truth; sync commands regenerate artifacts

## Implementation Steps

### 1. Epic Database Schema

```sql
CREATE TABLE epics (
    id TEXT PRIMARY KEY,              -- EPC-[P]-[NNNN] format
    title TEXT NOT NULL,
    description TEXT,
    status TEXT NOT NULL              -- Computed from subtasks
        CHECK(status IN ('TODO', 'UNDERWAY', 'COMPLETE', 'ABORTED')),
    priority TEXT NOT NULL
        CHECK(priority IN ('CRITICAL', 'HIGH', 'MEDIUM', 'LOW')),
    aborted_reason TEXT,              -- Only if manually aborted
    created_at TEXT NOT NULL DEFAULT (datetime('now')),
    updated_at TEXT NOT NULL DEFAULT (datetime('now')),
    completed_at TEXT,                -- Auto-set when all tasks complete
    aborted_at TEXT,                  -- Set when manually aborted
    file_path TEXT NOT NULL           -- .opencode/work/epics/EPC-H-0001.md
);

CREATE INDEX idx_epics_status ON epics(status);
CREATE INDEX idx_epics_priority ON epics(priority);
CREATE INDEX idx_epics_created ON epics(created_at);
```

### 2. Add Epic Reference to Tasks

```sql
ALTER TABLE tasks ADD COLUMN epic_id TEXT;

ALTER TABLE tasks ADD CONSTRAINT fk_tasks_epic 
    FOREIGN KEY (epic_id) REFERENCES epics(id) ON DELETE RESTRICT;

CREATE INDEX idx_tasks_epic ON tasks(epic_id);
```

### 3. Epic Status Auto-Update Trigger

```sql
CREATE TRIGGER update_epic_status_on_task_change
AFTER UPDATE OF status ON tasks
WHEN NEW.epic_id IS NOT NULL
BEGIN
    UPDATE epics SET 
        status = (
            CASE
                -- All tasks complete = epic complete
                WHEN NOT EXISTS (
                    SELECT 1 FROM tasks 
                    WHERE epic_id = NEW.epic_id AND status != 'COMPLETE'
                ) THEN 'COMPLETE'
                
                -- Any task active = epic underway
                WHEN EXISTS (
                    SELECT 1 FROM tasks 
                    WHERE epic_id = NEW.epic_id 
                    AND status IN ('UNDERWAY', 'BLOCKED', 'REVIEW', 'PAUSED')
                ) THEN 'UNDERWAY'
                
                -- All tasks TODO = epic todo
                ELSE 'TODO'
            END
        ),
        completed_at = (
            CASE 
                WHEN NOT EXISTS (
                    SELECT 1 FROM tasks 
                    WHERE epic_id = NEW.epic_id AND status != 'COMPLETE'
                ) THEN datetime('now')
                ELSE NULL
            END
        ),
        updated_at = datetime('now')
    WHERE id = NEW.epic_id AND status != 'ABORTED';
    -- Don't auto-update aborted epics
END;

CREATE TRIGGER update_epic_status_on_task_insert
AFTER INSERT ON tasks
WHEN NEW.epic_id IS NOT NULL
BEGIN
    -- Same logic as update trigger
    UPDATE epics SET 
        status = (
            CASE
                WHEN NOT EXISTS (
                    SELECT 1 FROM tasks 
                    WHERE epic_id = NEW.epic_id AND status != 'COMPLETE'
                ) THEN 'COMPLETE'
                WHEN EXISTS (
                    SELECT 1 FROM tasks 
                    WHERE epic_id = NEW.epic_id 
                    AND status IN ('UNDERWAY', 'BLOCKED', 'REVIEW', 'PAUSED')
                ) THEN 'UNDERWAY'
                ELSE 'TODO'
            END
        ),
        updated_at = datetime('now')
    WHERE id = NEW.epic_id AND status != 'ABORTED';
END;

CREATE TRIGGER update_epic_timestamp
AFTER UPDATE ON epics
FOR EACH ROW
BEGIN
    UPDATE epics SET updated_at = datetime('now')
    WHERE id = NEW.id;
END;
```

### 4. Epic Data Model (Python)

```python
from dataclasses import dataclass

@dataclass
class Epic:
    """Epic data model"""
    
    id: str                    # EPC-H-0001
    title: str
    description: str | None
    status: str               # TODO, UNDERWAY, COMPLETE, ABORTED
    priority: str             # CRITICAL, HIGH, MEDIUM, LOW
    aborted_reason: str | None
    created_at: str
    updated_at: str
    completed_at: str | None
    aborted_at: str | None
    file_path: str
    
    # Computed properties (not in DB)
    subtask_count: int | None = None
    completed_count: int | None = None
    
    @property
    def progress_percent(self) -> int:
        """Calculate completion percentage"""
        if not self.subtask_count or self.subtask_count == 0:
            return 0
        return int((self.completed_count / self.subtask_count) * 100)
```

### 5. Epic Manager Class

```python
class EpicManager:
    """Manages epic operations"""
    
    def create_epic(self, title: str, priority: str, description: str = None) -> Epic:
        """Create new epic with auto-generated ID"""
        pass
    
    def get_epic(self, epic_id: str) -> Epic | None:
        """Get epic by ID with progress data"""
        pass
    
    def list_epics(self, status: str = None, priority: str = None) -> list[Epic]:
        """List epics with optional filters"""
        pass
    
    def update_epic(self, epic_id: str, **updates) -> Epic:
        """Update epic fields"""
        pass
    
    def abort_epic(self, epic_id: str, reason: str) -> None:
        """Abort epic and all its subtasks"""
        pass
    
    def get_subtasks(self, epic_id: str) -> list[Task]:
        """Get all tasks belonging to epic"""
        pass
    
    def compute_progress(self, epic_id: str) -> dict:
        """Compute epic progress from subtasks"""
        pass
```

### 6. Migration Script

Create migration script to add epics table and update existing database:

```python
# migrations/add_epics_table.py
def upgrade(db):
    # Create epics table
    # Add epic_id column to tasks
    # Create triggers
    # Create indices
    pass

def downgrade(db):
    # Remove triggers
    # Remove epic_id column
    # Drop epics table
    pass
```

## Files Changed

### Created
- [file path] - [description]

### Modified
- [file path] - [description]

## Testing Performed

[Document test commands, results, verification]

## Notes

**Design Session:** Enlil (Administrator) on 2026-02-03

**Key Design Decisions:**

1. **Epic ID Format:** `EPC-[P]-[NNNN]` where P = priority (C/H/M/L)
   - Examples: `EPC-H-0001`, `EPC-C-0002`, `EPC-M-0003`
   - Consistent with task ID format

2. **Task-Epic Relationship:** One-to-one or none
   - Task can belong to at most one epic
   - Tasks can exist standalone (epic_id = NULL)
   - No nested epics (keep it simple)

3. **Epic Status:** Computed, not manual
   - TODO: All subtasks are TODO
   - UNDERWAY: At least one subtask active (UNDERWAY/BLOCKED/REVIEW/PAUSED)
   - COMPLETE: ALL subtasks are COMPLETE
   - ABORTED: Manually aborted (special case)

4. **Abort Cascade:** Epic abort → all subtasks abort
   - Requires double confirmation (CLI prompt + agent asks user)
   - Destructive operation, cannot be undone
   - Clears any session assignments on affected tasks

5. **Epic Artifacts:** Markdown files in `.opencode/work/epics/`
   - Include description, acceptance criteria, subtask table
   - Show progress bar and completion percentage
   - Updated when tasks link/unlink

6. **Sync Commands:** Database is source of truth
   - `s9 epic sync` regenerates epic artifacts from DB
   - `s9 task sync` regenerates task artifacts from DB
   - Used when manual edits or partial failures cause inconsistency

7. **Documentation:** New docs pages needed
   - Epic workflow guide
   - CLI reference for epic commands
   - Update task lifecycle docs

**Related Tasks:**
- BLD-H-0034: Epic ID generation
- BLD-H-0035: Epic CLI commands
- BLD-H-0036: Task-epic linking
- BLD-H-0037: Epic artifacts
- BLD-H-0038: Sync commands
- BLD-M-0039: Dashboard integration
- TST-H-0040: Epic tests
- DOC-M-0041: Epic documentation
- OPR-M-0042: Init templates

**Dependencies:**
- Must complete this schema design before other tasks can proceed
- Builder tasks depend on this architecture
- Tester tasks depend on builder implementation