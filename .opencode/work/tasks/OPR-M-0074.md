---
id: OPR-M-0074
title: Add --json output flag to all s9 commands
status: TODO
priority: MEDIUM
role: Operator
category: infrastructure
created_at: 2026-02-04T13:45:42
---

# Task: Add --json output flag to all s9 commands

## Context

Agents need machine-readable data, not formatted tables. All s9 commands should support --json flag for structured output that agents can parse.

**Related:** ADR-008 (Agent Messaging System) notes that agents should use --json mode for data consumption.

## Requirements

1. **Add --json/-j flag to ALL s9 commands:**
   - `mission list, show, start, end, rename-tui`
   - `task list, show, create, claim, complete, update`
   - `epic list, show, create, abort`
   - `comms inbox, list, show, send, discuss, reply, status` (when implemented)
   - `handoff list, show, create, accept`
   - `review list, show, create, approve, reject`
   - `dashboard`
   - `persona list, suggest`
   - Any other commands that produce output

2. **JSON output format:**
   - Consistent structure across commands
   - Include metadata (count, timestamp, etc.)
   - Handle errors in JSON format too
   
3. **Error handling:**
   - Errors should also output JSON when --json flag present
   - Example: `{"status": "error", "error": "Task not found", "task_id": "OPR-M-9999"}`

4. **Testing:**
   - Add tests for JSON output format
   - Verify all commands support --json
   - Test error cases in JSON mode

5. **Documentation:**
   - Update command help text to mention --json
   - Document JSON schema for each command
   - Add examples to docs

## Example Output

```bash
# Table format (default, for humans/Director)
s9 mission list --role Architect
â”â”â”â”â”â”â”â”â”³â”â”â”â”â”â”â”â”â”â”â”â”â”â”³â”â”â”â”â”â”â”â”â”â”â”â”“
â”ƒ ID    â”ƒ Persona     â”ƒ Role      â”ƒ
â”¡â”â”â”â”â”â”â”â•‡â”â”â”â”â”â”â”â”â”â”â”â”â”â•‡â”â”â”â”â”â”â”â”â”â”â”â”©
â”‚ 62    â”‚ ahura-mazda â”‚ Architect â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

# JSON format (for agents)
s9 mission list --role Architect --json
{
  "missions": [
    {
      "id": 62,
      "persona_name": "ahura-mazda",
      "role": "Architect",
      "codename": "swift-helix",
      "start_time": "2026-02-04T16:59:45",
      "end_time": null,
      "epic_id": "EPC-H-0004",
      "desk_mode_active": false,
      "desk_mode_epic_id": null
    }
  ],
  "count": 1,
  "timestamp": "2026-02-04T13:45:00"
}
```

## Usage Pattern (from ADR-008)

**Skills should instruct agents:**
- Use `--json` when agents need to consume data (parse, filter, process)
- Use table mode (default) when presenting information to Director

Example from session-start skill:
```bash
# Agent consumes this data
missions=$(s9 mission list --role Architect --json)

# Director sees this output
s9 mission list --active-only
```

## Acceptance Criteria

- [x] All existing s9 READ commands support --json flag (19 commands implemented)
- [x] JSON output follows consistent structure (data + metadata)
- [x] Errors are JSON-formatted when --json flag present
- [x] Tests added for JSON output validation (21 tests passing)
- [ ] Documentation updated with JSON schema examples
- [x] --json flag mentioned in all command --help text (for implemented commands)

## Progress Summary

### âœ… Completed (Phase 1 - READ Commands)

**Commands with --json support (19 total):**
- Mission: `list`, `show`, `summary`, `roles`
- Task: `list`, `show`, `mine`, `report`, `search`, `next`
- Epic: `list`, `show`
- Handoff: `list`, `show`
- Review: `list`, `show`
- Name: `list`, `suggest`, `show`
- Dashboard: main command

**Implementation:**
- Consistent JSON structure using `format_json_response()` utility
- Error handling using `format_json_error()` for not-found cases
- All timestamps in ISO 8601 format
- List responses include `count` field
- 21 comprehensive tests in `test_cli_json_output.py`

### ðŸ”„ Optional (Phase 2 - Additional Commands)

**Potentially useful READ commands:**
- `adr list` - For agents querying ADRs
- `review blocked` - Show blocked tasks

**WRITE commands (lower priority):**
- These typically just confirm success/failure
- Could add if needed: mission start/end, task create/claim, etc.
- JSON format: `{"status": "success", "id": "...", "message": "..."}`

### â­ï¸ Future Work

1. **Documentation:** Create JSON schema docs for each command
2. **ADR list:** Add --json to ADR list command (useful for agents)
3. **Write commands:** Add --json to write commands if needed for workflows

## Implementation Notes

- Consider creating a shared utility function/decorator for consistent JSON formatting
- May need to update Rich table rendering logic to conditionally output JSON
- Ensure datetime fields use ISO 8601 format in JSON

## Artifacts

### JSON Utilities

Created `src/site_nine/cli/json_utils.py` with:
- `format_json_response(data, count?, metadata?)` - Standard response formatting
- `format_json_error(error_message, error_code?, details?)` - Error responses
- `output_json(data, pretty?)` - Console output (uses `print()`, not `console.print()`)
- `to_json_serializable(obj)` - Handles Pydantic models, datetimes, etc.

### Standard Response Format

**Success Response:**
```json
{
  "data": [...] | {...},
  "count": 5,           // For list responses only
  "timestamp": "2026-02-04T14:21:06.439541"
}
```

**Error Response:**
```json
{
  "status": "error",
  "error": "Mission #999999 not found",
  "error_code": "MISSION_NOT_FOUND",
  "details": {"mission_id": 999999},
  "timestamp": "2026-02-04T14:21:14.280467"
}
```

### Implementation Pattern

```python
@app.command()
def command_name(
    # existing parameters...
    json_output: bool = typer.Option(False, "--json", "-j", help="Output in JSON format"),
) -> None:
    """Command description"""
    
    # ... command logic ...
    
    if json_output:
        data = [...]  # or {...}
        output_json(format_json_response(data))
        logger.debug(f"Command executed (JSON)")
        return
    
    # Original Rich table/console output
    # ...
```

### Test Coverage

All tests in `tests/test_cli_json_output.py` (21 tests):
- JSON structure validation
- Empty results handling
- Filter options
- Error responses
- Schema consistency across commands
