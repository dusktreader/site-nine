# Task OPR-M-0031: Add abandoned task detection to doctor command

**Status:** COMPLETE
**Priority:** MEDIUM
**Role:** Operator
**Category:** infrastructure
**Mission:** 42
**Claimed:** 2026-02-04 06:07:24
**Actual Time:** 
**Closed:** 2026-02-04 06:10:35
**Paused:** 
## Objective

Implement 's9 doctor --check-abandoned' to detect and help clean up orphaned tasks and stale agent sessions

## Problem Statement

**Current Issue:**
Tasks can become "abandoned" when:
1. Agent sessions crash (OpenCode closes unexpectedly)
2. User forgets to `/dismiss` agent properly
3. Agent completes work but doesn't mark task COMPLETE
4. Long-running tasks become stale

**Impact:**
- Task board shows incorrect state (e.g., OPR-H-0005 was UNDERWAY but actually complete)
- Resources appear claimed when they're not
- No visibility into stale/orphaned work
- Manual detective work required to find inconsistencies

**Current Workaround:**
Manual review of task files, agent sessions, and database to find mismatches.

**Desired State:**
Automated detection of:
- Tasks where `status=UNDERWAY` but agent `status IN (completed, failed, aborted)`
- Agent sessions marked `in-progress` but stale (old session files)
- Inconsistencies between database, task files, and session files

## Implementation Steps

### Phase 1: Design CLI Interface
- [ ] Add `--check-abandoned` flag to `s9 doctor` command
- [ ] Design output format (see example below)
- [ ] Consider interactive mode vs. report-only mode

### Phase 2: Implement Detection Logic
- [ ] Query for tasks where status=UNDERWAY AND agent.status IN (completed, failed, aborted)
- [ ] Identify tasks UNDERWAY for > N days (configurable threshold)
- [ ] Find agents with status=in-progress but old session files
- [ ] Cross-reference session file frontmatter with database state

### Phase 3: Implement Remediation Suggestions
- [ ] Suggest marking task COMPLETE if agent completed
- [ ] Suggest releasing claim if agent failed/aborted
- [ ] Suggest aborting stale agent sessions
- [ ] Optionally: Add `--fix` flag to auto-remediate (with confirmation)

### Phase 4: Testing
- [ ] Test with known abandoned task (e.g., manually create inconsistent state)
- [ ] Test detection of completed agent with UNDERWAY task
- [ ] Test detection of stale sessions
- [ ] Test output formatting and readability

### Example Output:
```bash
$ s9 doctor --check-abandoned

⚠️  Found potentially abandoned work:

Tasks:
- OPR-H-0005 (UNDERWAY) - claimed by cronos (agent #5) on 2026-02-02
  Agent status: completed
  Last session: 2026-02-01.20:47:56.operator.atlas.initial-session.md
  → Recommendation: Task appears complete but not marked. Mark as COMPLETE?

- BLD-M-0012 (UNDERWAY) - claimed by azazel (agent #8) on 2026-02-01  
  Agent status: in-progress
  Last session: 2026-02-01.15:30:45.builder.azazel.feature-x.md
  → Recommendation: Stale for 2+ days. Release claim?

Agents:
- Agent #3 (marduk) - status: in-progress, started 3 days ago
  → Recommendation: Session may be abandoned. Mark as aborted?

Run 's9 doctor --check-abandoned --fix' to auto-remediate with confirmation.
```

## Files Changed

### Modified
- `src/site_nine/cli/doctor.py` - Added Check 5: Abandoned work detection with three sub-checks

## Implementation Details

**What was implemented:**

Added a new check section (Check 5) to the `s9 doctor` command that detects three types of abandoned work:

1. **Tasks abandoned by ended missions** - Detects tasks with status=UNDERWAY but whose current_mission_id points to a mission that has ended (end_time IS NOT NULL)
   - Auto-fixable: Clears the current_mission_id with `--fix` flag
   - User must manually review task and mark COMPLETE or TODO

2. **Orphaned UNDERWAY tasks** - Detects tasks with status=UNDERWAY but no current_mission_id
   - Warning only: No automatic fix (user must review)
   - Suggests manual review to release claim or complete task

3. **Stale active missions** - Detects missions without end_time but mission file hasn't been modified in >48 hours
   - Warning only: No automatic fix
   - Suggests using `s9 mission end <id>` to close abandoned missions

**Integration with existing doctor command:**
- Follows same pattern as existing checks (1-4)
- Uses same issue tracking structure: `(category, severity, issue, fix_fn)`
- Supports `--fix` flag for auto-remediating abandoned tasks
- Supports `--verbose` flag for detailed output
- Provides actionable suggestions for manual fixes

## Testing Performed

**Test 1: Basic detection**
```bash
$ s9 doctor
# Output showed:
# ✓ No tasks abandoned by ended missions
# ⚠ Found 3 orphaned UNDERWAY tasks
# ✓ No stale active missions
```

**Test 2: Verbose output**
```bash
$ s9 doctor --verbose
# Showed detailed information about each orphaned task
```

**Test 3: Auto-fix for abandoned tasks**
```bash
$ s9 doctor --fix
# Successfully cleared current_mission_id for task OPR-H-0049
# which was claimed by ended mission #43
```

**Test 4: Verification after fix**
```bash
$ s9 doctor
# Confirmed task no longer shows as "abandoned by ended mission"
# Now shows as "orphaned UNDERWAY task" (expected behavior)
```

**Verified with real data:**
- Found and fixed task OPR-H-0049 which was claimed by mission #43 (nanna/rogue-cipher) that we closed during mission cleanup
- Detected 3 orphaned UNDERWAY tasks that need manual review
- No stale active missions detected (as expected after recent cleanup)

## Notes

**Related Discussion:** Nyx (Operator) session on 2026-02-03

**Detection Criteria:**
1. **Completed Agent + UNDERWAY Task:** Clear mismatch - task should be COMPLETE
2. **Aborted/Failed Agent + UNDERWAY Task:** Should release claim, mark TODO or ABORTED
3. **Stale Task:** UNDERWAY for > 48 hours with no agent activity
4. **Stale Agent:** status=in-progress but session file > 24 hours old

**Future Enhancements:**
- Heartbeat mechanism for active agent detection
- Dashboard integration (show stale badges)
- Session startup check (warn if user has abandoned work)
- Auto-abort agents after N hours of inactivity (configurable)

**Design Decisions:**
- Start with manual report (`--check-abandoned`)
- Add optional auto-fix (`--fix`) with confirmation prompts
- Focus on task/agent status mismatches first (low-hanging fruit)
- Session file analysis can come in Phase 2