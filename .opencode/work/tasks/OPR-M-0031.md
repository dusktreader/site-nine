# Task OPR-M-0031: Add abandoned task detection to doctor command

**Status:** TODO
**Priority:** MEDIUM
**Role:** Operator
**Category:** infrastructure
**Agent:** 
**Claimed:** 
**Actual Time:** 
**Closed:** 
**Paused:** 
## Objective

Implement 's9 doctor --check-abandoned' to detect and help clean up orphaned tasks and stale agent sessions

## Problem Statement

**Current Issue:**
Tasks can become "abandoned" when:
1. Agent sessions crash (OpenCode closes unexpectedly)
2. User forgets to `/dismiss` agent properly
3. Agent completes work but doesn't mark task COMPLETE
4. Long-running tasks become stale

**Impact:**
- Task board shows incorrect state (e.g., OPR-H-0005 was UNDERWAY but actually complete)
- Resources appear claimed when they're not
- No visibility into stale/orphaned work
- Manual detective work required to find inconsistencies

**Current Workaround:**
Manual review of task files, agent sessions, and database to find mismatches.

**Desired State:**
Automated detection of:
- Tasks where `status=UNDERWAY` but agent `status IN (completed, failed, aborted)`
- Agent sessions marked `in-progress` but stale (old session files)
- Inconsistencies between database, task files, and session files

## Implementation Steps

### Phase 1: Design CLI Interface
- [ ] Add `--check-abandoned` flag to `s9 doctor` command
- [ ] Design output format (see example below)
- [ ] Consider interactive mode vs. report-only mode

### Phase 2: Implement Detection Logic
- [ ] Query for tasks where status=UNDERWAY AND agent.status IN (completed, failed, aborted)
- [ ] Identify tasks UNDERWAY for > N days (configurable threshold)
- [ ] Find agents with status=in-progress but old session files
- [ ] Cross-reference session file frontmatter with database state

### Phase 3: Implement Remediation Suggestions
- [ ] Suggest marking task COMPLETE if agent completed
- [ ] Suggest releasing claim if agent failed/aborted
- [ ] Suggest aborting stale agent sessions
- [ ] Optionally: Add `--fix` flag to auto-remediate (with confirmation)

### Phase 4: Testing
- [ ] Test with known abandoned task (e.g., manually create inconsistent state)
- [ ] Test detection of completed agent with UNDERWAY task
- [ ] Test detection of stale sessions
- [ ] Test output formatting and readability

### Example Output:
```bash
$ s9 doctor --check-abandoned

⚠️  Found potentially abandoned work:

Tasks:
- OPR-H-0005 (UNDERWAY) - claimed by cronos (agent #5) on 2026-02-02
  Agent status: completed
  Last session: 2026-02-01.20:47:56.operator.atlas.initial-session.md
  → Recommendation: Task appears complete but not marked. Mark as COMPLETE?

- BLD-M-0012 (UNDERWAY) - claimed by azazel (agent #8) on 2026-02-01  
  Agent status: in-progress
  Last session: 2026-02-01.15:30:45.builder.azazel.feature-x.md
  → Recommendation: Stale for 2+ days. Release claim?

Agents:
- Agent #3 (marduk) - status: in-progress, started 3 days ago
  → Recommendation: Session may be abandoned. Mark as aborted?

Run 's9 doctor --check-abandoned --fix' to auto-remediate with confirmation.
```

## Files Changed

### Created
- [file path] - [description]

### Modified
- [file path] - [description]

## Testing Performed

[Document test commands, results, verification]

## Notes

**Related Discussion:** Nyx (Operator) session on 2026-02-03

**Detection Criteria:**
1. **Completed Agent + UNDERWAY Task:** Clear mismatch - task should be COMPLETE
2. **Aborted/Failed Agent + UNDERWAY Task:** Should release claim, mark TODO or ABORTED
3. **Stale Task:** UNDERWAY for > 48 hours with no agent activity
4. **Stale Agent:** status=in-progress but session file > 24 hours old

**Future Enhancements:**
- Heartbeat mechanism for active agent detection
- Dashboard integration (show stale badges)
- Session startup check (warn if user has abandoned work)
- Auto-abort agents after N hours of inactivity (configurable)

**Design Decisions:**
- Start with manual report (`--check-abandoned`)
- Add optional auto-fix (`--fix`) with confirmation prompts
- Focus on task/agent status mismatches first (low-hanging fruit)
- Session file analysis can come in Phase 2