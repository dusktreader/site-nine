# Handoff: Entity Model Refactor - Ready for Implementation

**From:** Operator (Hemera)  
**To:** Operator (any)  
**Date:** 2026-02-03 16:51:13  
**Status:** PENDING  
**Priority:** HIGH  
**Task:** OPR-H-0032 - Entity Model Refactor (Personas, Missions, Clear Terminology)

---

## Context: What Was Done

### ✅ Design Phase Complete

I (Hemera, Operator) completed the **architectural design** for the entity model refactor. This is a major breaking-change refactor that will clarify terminology and fix abandoned mission problems.

**Key accomplishments:**

1. **Created ADR-006** (`.opencode/docs/adrs/ADR-006-entity-model-clarity.md`)
   - Complete architectural decision record
   - Full problem analysis and solution design
   - 6-phase implementation plan
   - Schema changes documented
   - Migration strategy defined

2. **Designed Mission Codenames**
   - Deterministic algorithm using prime numbers (31×37 = 1,147 combinations)
   - Tech-noir themed word lists (cyberpunk, cosmic, tactical)
   - Auto-generated from mission_id (no user input)
   - Examples: `silent-phoenix`, `crimson-falcon`, `void-matrix`

3. **OpenCode Session Naming**
   - Session titles include mission codename: `Persona - Role - codename`
   - Example: "Hemera - Operator - swift-thunder"
   - Command updated: `s9 mission rename-tui <persona> <Role> <codename>`

4. **Retroactive Migration Scope Defined**
   - 38 existing missions get codenames
   - 57 session markdown files updated
   - 11 abandoned "in-progress" missions closed
   - Directory rename: `sessions/` → `missions/`
   - Full content terminology updates

5. **Updated Documentation**
   - Task file OPR-H-0032 updated with design summary
   - session-start skill updated with new rename-tui command

**Director approved all design decisions:**
- ✅ 31×37 prime lists (no user codenames)
- ✅ Triple-dash session title format
- ✅ Breaking change (no backward compatibility)
- ✅ Rename all 57 files with codenames
- ✅ Close 11 abandoned missions
- ✅ Update file content terminology

---

## Current State

### Files to Review

**Primary documents:**
1. `.opencode/docs/adrs/ADR-006-entity-model-clarity.md` - **START HERE**
   - Complete architectural design (393 lines)
   - Read sections: Context, Decision, Consequences, Implementation Plan
   - Pay special attention to Phase 2 (lines 306-400) for migration details

2. `.opencode/work/tasks/OPR-H-0032.md` - Task tracking file
   - Updated with design summary
   - Status: TODO (ready for implementation)
   - See new "Status Update" section at top

3. `.opencode/skills/session-start/SKILL.md` - Updated skill
   - Lines 382-425 changed: New `rename-tui` command with codename parameter

**Database state:**
- 38 agent records (27 completed, 11 "in-progress")
- 57 session markdown files in `.opencode/work/sessions/`
- Database: `.opencode/data/project.db`

**Code locations:**
- Python module: `src/site_nine/agents/` (will rename to `missions/`)
- CLI commands: `src/site_nine/cli/agent.py` (695 lines)
- 9 Python files import/reference agents module

---

## What You Need to Do

### Primary Task: Implement Phase 2 (Database and File Migration)

You need to create and execute the migration script that transforms the current "agent session" model into the new "persona mission" model.

**Your deliverables:**

1. **Migration script:** `scripts/migrate_to_personas_missions.py`
   - Throwaway script (one-time execution)
   - Database schema changes (rename tables, add/remove columns)
   - Generate codenames for all 38 missions
   - Update 57 session markdown files
   - Close 11 abandoned missions
   - Validate data integrity

2. **Execute migration:**
   - Backup database before running
   - Run migration script
   - Validate results (all files renamed, codenames assigned, no data loss)

3. **Verify migration success:**
   - Check database schema matches ADR-006
   - Check all 57 files renamed and updated
   - Check 11 abandoned missions have `end_time` set
   - Check no data corruption

**See ADR-006 Phase 2 (lines 306-400) for complete implementation details.**

---

## Approach

### Recommended Implementation Order

**Step 1: Read ADR-006 Thoroughly** (30 mins)
- Understand the problem (lines 9-72)
- Understand the solution (lines 74-255)
- Study Phase 2 migration plan (lines 306-400)
- Note the database changes and file updates required

**Step 2: Create Migration Script** (3-4 hours)
```python
# scripts/migrate_to_personas_missions.py

# Script should:
# 1. Backup database
# 2. Rename daemon_names → personas
# 3. Rename agents → missions
# 4. Add codename column
# 5. Generate codenames deterministically
# 6. Close 11 abandoned missions
# 7. Update tasks table (add current_mission_id, remove agent_id/agent_name)
# 8. Update indices and foreign keys
# 9. Rename directory sessions/ → missions/
# 10. Update all 57 markdown files (frontmatter, filename, content)
# 11. Validate everything
```

**Step 3: Test on Database Copy** (1 hour)
```bash
# Copy database
cp .opencode/data/project.db .opencode/data/project.db.backup

# Test migration
python scripts/migrate_to_personas_missions.py
```

**Step 4: Execute Real Migration** (30 mins)
```bash
# Run for real
python scripts/migrate_to_personas_missions.py

# Verify results
sqlite3 .opencode/data/project.db "SELECT id, persona_name, codename FROM missions LIMIT 10"
ls .opencode/work/missions/*.md | head -10
```

**Step 5: Validation** (1 hour)
- Check all 57 files renamed
- Check all missions have codenames
- Check 11 missions closed
- Check directory renamed
- Check no data loss

**Total estimated: 5-7 hours**

---

## Important Context

### Critical Design Points

1. **Prime Number Strategy:**
   ```python
   # Codename generation MUST use this algorithm:
   adjective = ADJECTIVES[mission_id % 31]
   noun = NOUNS[mission_id % 37]
   codename = f"{adjective}-{noun}"
   ```
   
2. **File Renaming Pattern:**
   ```
   OLD: 2026-02-02.11:03:39.documentarian.calliope.initial-session.md
   NEW: 2026-02-02.11:03:39.documentarian.calliope.iron-cascade.md
   ```

3. **Frontmatter Updates:**
   ```yaml
   # OLD
   name: calliope
   status: completed
   task_summary: Initial audit
   
   # NEW
   persona: calliope
   codename: iron-cascade
   mission_id: 17
   objective: Initial audit
   # status removed
   ```

4. **Content Terminology Replacements:**
   - "Agent:" → "Persona:"
   - "agent session" → "mission"
   - "Session started" → "Mission started"
   - "Session completed" → "Mission completed"
   - "Agent name" → "Persona name"

5. **Close Abandoned Missions:**
   ```python
   # For 11 missions with status='in-progress':
   # Set end_time to file's last modified time (mtime)
   ```

### Gotchas & Warnings

1. **SQLite Limitations:**
   - No `DROP COLUMN` support
   - Must recreate tables to remove columns
   - Use transactions for atomicity

2. **Breaking Change:**
   - No rollback strategy (one-way migration)
   - Backup is for disaster recovery only
   - Test on database copy first!

3. **File Paths:**
   - 57 files to rename - track progress carefully
   - Update any references in code that use old paths
   - Directory rename happens AFTER file updates

4. **Persona Capitalization:**
   - Store lowercase in database/frontmatter: `persona: hemera`
   - Display capitalized in UI: "Hemera"
   - Session titles: "Hemera - Operator - swift-thunder"

5. **Mission ID Mapping:**
   - mission_id must match database auto-increment ID
   - Codename generation relies on correct mission_id
   - Validate codename uniqueness after generation

### Questions to Consider

- **Should migration be idempotent?** (Can it be run multiple times safely?)
- **Should we log each file update?** (For debugging if something fails)
- **Should we validate codenames match before/after?** (Generate expected vs actual)
- **How to handle missing files?** (DB record exists but markdown file missing)

---

## Acceptance Criteria

Migration is complete when:

- [ ] Database tables renamed: `daemon_names` → `personas`, `agents` → `missions`
- [ ] All 38 missions have deterministic codenames in database
- [ ] All 57 session files renamed with codenames
- [ ] All 57 session files have updated frontmatter
- [ ] All 57 session files have updated content terminology
- [ ] Directory renamed: `.opencode/work/sessions/` → `.opencode/work/missions/`
- [ ] 11 abandoned missions have `end_time` set
- [ ] Tasks table has `current_mission_id` column
- [ ] Tasks table no longer has `agent_id` or `agent_name` columns
- [ ] No data loss (all 38 missions accounted for)
- [ ] No duplicate codenames (validate uniqueness)
- [ ] Database backup exists before migration
- [ ] Can query: `SELECT * FROM missions WHERE codename LIKE 'swift-%'`
- [ ] Can list: `ls .opencode/work/missions/*.md`

---

## Next Steps

1. **Read ADR-006 completely** - Understand the full design
2. **Study Phase 2 implementation plan** (lines 306-400 in ADR-006)
3. **Create migration script** with all 11 steps from Phase 2
4. **Test on database copy** first
5. **Execute real migration** with backup
6. **Validate all acceptance criteria**
7. **Update this handoff** to `.accepted.md` when you start
8. **Mark OPR-H-0032** as UNDERWAY when you claim it

---

## Resources & Links

### Documentation
- **ADR-006:** `.opencode/docs/adrs/ADR-006-entity-model-clarity.md`
- **Task:** `.opencode/work/tasks/OPR-H-0032.md`
- **Updated Skill:** `.opencode/skills/session-start/SKILL.md` (lines 382-425)

### Database
- **Database file:** `.opencode/data/project.db`
- **Current schema:** Run `sqlite3 .opencode/data/project.db .schema`

### Code to Review
- **Agent sessions manager:** `src/site_nine/agents/sessions.py` (293 lines)
- **CLI commands:** `src/site_nine/cli/agent.py` (695 lines)
- **All imports:** 9 Python files reference agents module

### Session Files
- **Directory:** `.opencode/work/sessions/` (57 files)
- **Sample files:**
  - `2026-02-02.11:03:39.documentarian.calliope.initial-session.md`
  - `2026-02-01.20:46:19.engineer.goibniu.initial-session.md`

### Query Examples
```bash
# Count missions by status
sqlite3 .opencode/data/project.db "SELECT status, COUNT(*) FROM agents GROUP BY status"

# Find in-progress missions
sqlite3 .opencode/data/project.db "SELECT id, name, session_date FROM agents WHERE status='in-progress'"

# List session files
ls -t .opencode/work/sessions/*.md | head -10
```

---

## Estimated Effort

**Phase 2 (Database and File Migration):** 5-7 hours

**Breakdown:**
- Read ADR-006 thoroughly: 30 mins
- Create migration script: 3-4 hours
- Test on database copy: 1 hour
- Execute real migration: 30 mins
- Validation: 1 hour

**Note:** This is ONLY Phase 2. Phases 3-6 (code refactoring, CLI updates, etc.) will follow in subsequent work sessions.

---

## Contact

**From:** Hemera (Operator)  
**Session:** 2026-02-03 (current session)  
**Task:** OPR-H-0032  

**Questions?** Review ADR-006 first - it has comprehensive design details. If still unclear, feel free to ask the Director for clarification.

**Ready to start?** Use `/summon operator` and claim task OPR-H-0032!

---

**Last updated:** 2026-02-03 16:51:13 by Hemera
